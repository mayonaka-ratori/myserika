<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MY-SECRETARY Dashboard</title>
  <style>
    :root {
      --bg: #0a0a0f;
      --surface: #0f0f1a;
      --card: #12121e;
      --card-border: #1e1e32;
      --accent: #7c5cbf;
      --accent-dim: #5a3fa0;
      --text: #e0e0f0;
      --text-dim: #8888aa;
      --success: #4caf50;
      --warn: #ff9800;
      --danger: #f44336;
      --info: #2196f3;
      --sidebar-w: 220px;
      --header-h: 56px;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      background: var(--bg);
      color: var(--text);
      font-family: 'Segoe UI', system-ui, sans-serif;
      font-size: 14px;
      min-height: 100vh;
    }

    /* â”€â”€â”€ Header â”€â”€â”€ */
    header {
      position: fixed;
      top: 0; left: 0; right: 0;
      height: var(--header-h);
      background: var(--surface);
      border-bottom: 1px solid var(--card-border);
      display: flex;
      align-items: center;
      padding: 0 20px;
      gap: 16px;
      z-index: 100;
    }

    .logo {
      font-size: 16px;
      font-weight: 700;
      letter-spacing: 1px;
      color: var(--accent);
    }

    .logo span { color: var(--text); }

    .header-clock {
      margin-left: auto;
      font-size: 13px;
      color: var(--text-dim);
      font-variant-numeric: tabular-nums;
    }

    .status-badge {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 12px;
      color: var(--success);
    }

    .status-dot {
      width: 8px; height: 8px;
      border-radius: 50%;
      background: var(--success);
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.4; }
    }

    /* â”€â”€â”€ Layout â”€â”€â”€ */
    .layout {
      display: flex;
      padding-top: var(--header-h);
      min-height: 100vh;
    }

    /* â”€â”€â”€ Sidebar â”€â”€â”€ */
    nav {
      width: var(--sidebar-w);
      background: var(--surface);
      border-right: 1px solid var(--card-border);
      padding: 20px 0;
      position: fixed;
      top: var(--header-h);
      bottom: 0;
      overflow-y: auto;
    }

    .nav-label {
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 1.5px;
      color: var(--text-dim);
      padding: 8px 20px 4px;
    }

    .nav-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 16px;
      margin: 2px 8px;
      border-radius: 7px;
      cursor: pointer;
      color: var(--text-dim);
      transition: all 0.15s;
      text-decoration: none;
      user-select: none;
    }

    .nav-item:hover {
      background: rgba(124,92,191,0.12);
      color: var(--text);
    }

    .nav-item.active {
      background: rgba(124,92,191,0.2);
      color: var(--accent);
    }

    .nav-item .nav-icon { font-size: 15px; }

    .badge {
      margin-left: auto;
      background: var(--accent);
      color: #fff;
      font-size: 10px;
      font-weight: 700;
      padding: 2px 6px;
      border-radius: 10px;
      min-width: 18px;
      text-align: center;
    }

    .badge.warn { background: var(--warn); }
    .badge.danger { background: var(--danger); }

    /* â”€â”€â”€ Main content â”€â”€â”€ */
    main {
      margin-left: var(--sidebar-w);
      flex: 1;
      padding: 24px;
      overflow-y: auto;
    }

    .view { display: block; }
    .view[hidden] { display: none !important; }

    .view-title {
      font-size: 20px;
      font-weight: 700;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 10px;
      color: var(--text);
    }

    .section-title {
      font-size: 15px;
      font-weight: 600;
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 8px;
      color: var(--text);
    }

    .grid-2 {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
      gap: 16px;
      margin-bottom: 20px;
    }

    /* â”€â”€â”€ Cards â”€â”€â”€ */
    .card {
      background: var(--card);
      border: 1px solid var(--card-border);
      border-radius: 10px;
      padding: 20px;
    }

    .card-header {
      display: flex;
      align-items: center;
      gap: 8px;
      font-weight: 600;
      margin-bottom: 16px;
      color: var(--text);
    }

    .card-header .icon { font-size: 16px; }

    /* â”€â”€â”€ Stat numbers â”€â”€â”€ */
    .stats-row {
      display: flex;
      gap: 12px;
      margin-bottom: 20px;
    }

    .stat-item {
      flex: 1;
      background: var(--surface);
      border-radius: 8px;
      padding: 14px;
      text-align: center;
    }

    .stat-value {
      font-size: 32px;
      font-weight: 700;
      font-variant-numeric: tabular-nums;
      line-height: 1;
      margin-bottom: 4px;
    }

    .stat-value.warn { color: var(--warn); }
    .stat-value.success { color: var(--success); }
    .stat-value.info { color: var(--info); }
    .stat-value.accent { color: var(--accent); }

    .stat-label {
      font-size: 11px;
      color: var(--text-dim);
    }

    /* â”€â”€â”€ Table â”€â”€â”€ */
    .table-wrap { overflow-x: auto; }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    th {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.8px;
      color: var(--text-dim);
      padding: 8px 10px;
      text-align: left;
      border-bottom: 1px solid var(--card-border);
    }

    td {
      padding: 10px 10px;
      border-bottom: 1px solid rgba(255,255,255,0.04);
      vertical-align: top;
    }

    tr:last-child td { border-bottom: none; }

    tr.removing {
      opacity: 0;
      transform: translateX(20px);
      transition: all 0.3s ease;
    }

    .subject-cell {
      max-width: 200px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .category-tag {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 600;
    }

    .category-tag.urgent { background: rgba(244,67,54,0.2); color: var(--danger); }
    .category-tag.normal { background: rgba(33,150,243,0.2); color: var(--info); }
    .category-tag.info-tag { background: rgba(255,152,0,0.2); color: var(--warn); }
    .category-tag.spam { background: rgba(136,136,136,0.2); color: var(--text-dim); }

    /* â”€â”€â”€ Status tag â”€â”€â”€ */
    .status-tag {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 600;
    }

    .status-tag.pending  { background: rgba(255,152,0,0.2);   color: var(--warn); }
    .status-tag.approved { background: rgba(76,175,80,0.2);    color: var(--success); }
    .status-tag.rejected { background: rgba(244,67,54,0.15);   color: var(--danger); }
    .status-tag.read_only{ background: rgba(136,136,136,0.2);  color: var(--text-dim); }

    .draft-preview {
      max-width: 220px;
      font-size: 12px;
      color: var(--text-dim);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .btn-group { display: flex; gap: 6px; flex-wrap: wrap; }

    .btn {
      padding: 5px 12px;
      border-radius: 5px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      border: none;
      transition: opacity 0.15s;
    }

    .btn:hover { opacity: 0.8; }
    .btn:disabled { opacity: 0.4; cursor: not-allowed; }

    .btn-approve {
      background: rgba(76,175,80,0.2);
      color: var(--success);
      border: 1px solid rgba(76,175,80,0.4);
    }

    .btn-reject {
      background: rgba(244,67,54,0.15);
      color: var(--danger);
      border: 1px solid rgba(244,67,54,0.3);
    }

    .btn-primary {
      background: var(--accent);
      color: #fff;
    }

    .btn-secondary {
      background: var(--card-border);
      color: var(--text);
    }

    .empty-state {
      text-align: center;
      padding: 32px 16px;
      color: var(--text-dim);
    }

    .empty-icon { font-size: 32px; margin-bottom: 8px; }

    /* â”€â”€â”€ Timeline â”€â”€â”€ */
    .timeline { position: relative; }

    .timeline-item {
      display: flex;
      gap: 14px;
      padding: 10px 0;
      position: relative;
    }

    .timeline-item::before {
      content: '';
      position: absolute;
      left: 35px;
      top: 28px;
      bottom: -10px;
      width: 1px;
      background: var(--card-border);
    }

    .timeline-item:last-child::before { display: none; }

    .timeline-time {
      min-width: 44px;
      font-size: 11px;
      color: var(--text-dim);
      font-variant-numeric: tabular-nums;
      padding-top: 2px;
    }

    .timeline-dot {
      width: 10px; height: 10px;
      border-radius: 50%;
      background: var(--accent);
      margin-top: 4px;
      flex-shrink: 0;
    }

    .timeline-dot.allday { background: var(--text-dim); }

    .timeline-content { flex: 1; }

    .timeline-title {
      font-size: 13px;
      font-weight: 500;
    }

    .timeline-sub {
      font-size: 11px;
      color: var(--text-dim);
      margin-top: 2px;
    }

    /* â”€â”€â”€ Progress bar â”€â”€â”€ */
    .progress-label {
      display: flex;
      justify-content: space-between;
      margin-bottom: 6px;
      font-size: 12px;
      color: var(--text-dim);
    }

    .progress-bar {
      height: 6px;
      background: var(--card-border);
      border-radius: 3px;
      overflow: hidden;
      margin-bottom: 14px;
    }

    .progress-fill {
      height: 100%;
      border-radius: 3px;
      background: var(--accent);
      transition: width 0.5s ease;
    }

    .progress-fill.warn { background: var(--warn); }
    .progress-fill.danger { background: var(--danger); }

    /* â”€â”€â”€ Live feed â”€â”€â”€ */
    #live-feed {
      display: flex;
      flex-direction: column;
      gap: 6px;
      max-height: 260px;
      overflow-y: auto;
    }

    .feed-item {
      display: flex;
      align-items: flex-start;
      gap: 10px;
      padding: 8px 10px;
      background: var(--surface);
      border-radius: 6px;
      font-size: 12px;
      animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-4px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .feed-time {
      color: var(--text-dim);
      font-variant-numeric: tabular-nums;
      flex-shrink: 0;
    }

    .feed-msg { color: var(--text); flex: 1; }

    .feed-type {
      font-size: 10px;
      padding: 1px 6px;
      border-radius: 3px;
      flex-shrink: 0;
    }

    .feed-type.processed { background: rgba(76,175,80,0.2); color: var(--success); }
    .feed-type.rejected { background: rgba(244,67,54,0.15); color: var(--danger); }
    .feed-type.info { background: rgba(33,150,243,0.2); color: var(--info); }
    .feed-type.dismissed { background: rgba(136,136,136,0.2); color: var(--text-dim); }

    .ws-status {
      font-size: 11px;
      color: var(--text-dim);
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .ws-dot {
      width: 6px; height: 6px;
      border-radius: 50%;
      background: var(--text-dim);
    }

    .ws-dot.connected { background: var(--success); }

    /* â”€â”€â”€ Pending preview list â”€â”€â”€ */
    .pending-preview-item {
      padding: 10px 0;
      border-bottom: 1px solid rgba(255,255,255,0.05);
    }
    .pending-preview-item:last-child { border-bottom: none; }
    .pending-preview-subject {
      font-size: 13px;
      font-weight: 500;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .pending-preview-sender {
      font-size: 11px;
      color: var(--text-dim);
      margin-top: 2px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    /* â”€â”€â”€ Contacts grid â”€â”€â”€ */
    .contacts-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
      gap: 12px;
    }

    .contact-card {
      background: var(--surface);
      border: 1px solid var(--card-border);
      border-radius: 8px;
      padding: 14px;
    }

    .contact-name {
      font-weight: 600;
      font-size: 14px;
      margin-bottom: 4px;
    }

    .contact-email {
      font-size: 11px;
      color: var(--text-dim);
      margin-bottom: 8px;
      word-break: break-all;
    }

    .priority-badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 10px;
      font-weight: 700;
    }

    .priority-badge.high { background: rgba(244,67,54,0.2); color: var(--danger); }
    .priority-badge.medium { background: rgba(255,152,0,0.2); color: var(--warn); }
    .priority-badge.low { background: rgba(136,136,136,0.2); color: var(--text-dim); }

    /* â”€â”€â”€ Mail tab bar â”€â”€â”€ */
    .tab-bar {
      display: flex;
      gap: 4px;
      padding: 4px;
      background: var(--surface);
      border-radius: 8px;
      margin-bottom: 14px;
      flex-wrap: wrap;
    }

    .tab-btn {
      padding: 6px 14px;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      color: var(--text-dim);
      background: transparent;
      border: none;
      display: flex;
      align-items: center;
      gap: 6px;
      transition: all 0.15s;
    }

    .tab-btn:hover { color: var(--text); background: rgba(124,92,191,0.1); }
    .tab-btn.active { background: rgba(124,92,191,0.2); color: var(--accent); }

    .tab-badge {
      background: var(--card-border);
      color: var(--text-dim);
      font-size: 10px;
      padding: 1px 6px;
      border-radius: 8px;
      min-width: 16px;
      text-align: center;
    }

    .tab-btn.active .tab-badge { background: var(--accent); color: #fff; }

    /* â”€â”€â”€ Search bar â”€â”€â”€ */
    .search-bar {
      width: 100%;
      background: var(--surface);
      border: 1px solid var(--card-border);
      border-radius: 6px;
      color: var(--text);
      font-size: 13px;
      padding: 8px 12px;
      outline: none;
      margin-bottom: 12px;
    }

    .search-bar:focus { border-color: var(--accent); }
    .search-bar::placeholder { color: var(--text-dim); }

    /* â”€â”€â”€ Mail table â”€â”€â”€ */
    .mail-row { cursor: pointer; }
    .mail-row:hover td { background: rgba(124,92,191,0.05); }

    /* â”€â”€â”€ Accordion detail row â”€â”€â”€ */
    .accordion-detail { display: none; }
    .accordion-detail.open { display: table-row; }
    .accordion-detail td { background: rgba(10,10,20,0.6); }

    .body-preview {
      background: var(--surface);
      border-radius: 6px;
      padding: 10px;
      font-size: 12px;
      color: var(--text-dim);
      white-space: pre-wrap;
      max-height: 100px;
      overflow-y: auto;
      line-height: 1.5;
    }

    .draft-ta {
      width: 100%;
      min-height: 110px;
      background: var(--surface);
      border: 1px solid var(--card-border);
      border-radius: 6px;
      color: var(--text);
      font-family: 'Consolas', 'Courier New', monospace;
      font-size: 12px;
      line-height: 1.5;
      padding: 10px;
      resize: vertical;
      outline: none;
      margin-top: 8px;
    }

    .draft-ta:focus { border-color: var(--accent); }
    .draft-ta[readonly] { opacity: 0.7; cursor: default; }

    .expand-arrow {
      font-size: 11px;
      transition: transform 0.2s;
      color: var(--text-dim);
    }

    .mail-row.expanded .expand-arrow { transform: rotate(180deg); }

    /* â”€â”€â”€ Settings tabs â”€â”€â”€ */
    .settings-tab-bar {
      display: flex;
      gap: 0;
      margin-bottom: 20px;
      border-bottom: 1px solid var(--card-border);
    }

    .settings-tab-btn {
      padding: 9px 18px;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      color: var(--text-dim);
      background: transparent;
      border: none;
      border-bottom: 2px solid transparent;
      margin-bottom: -1px;
      transition: all 0.15s;
    }

    .settings-tab-btn:hover { color: var(--text); }
    .settings-tab-btn.active { color: var(--accent); border-bottom-color: var(--accent); }

    .settings-tab-content { display: none; }
    .settings-tab-content.active { display: block; }

    /* â”€â”€â”€ Settings â”€â”€â”€ */
    .settings-section {
      margin-bottom: 24px;
    }

    .settings-label {
      font-size: 12px;
      color: var(--text-dim);
      margin-bottom: 8px;
      display: block;
    }

    textarea.memory-editor {
      width: 100%;
      min-height: 400px;
      background: var(--surface);
      border: 1px solid var(--card-border);
      border-radius: 6px;
      color: var(--text);
      font-family: 'Consolas', 'Courier New', monospace;
      font-size: 13px;
      line-height: 1.6;
      padding: 12px;
      resize: vertical;
      outline: none;
    }

    textarea.memory-editor:focus {
      border-color: var(--accent);
    }

    .save-status {
      font-size: 12px;
      color: var(--text-dim);
      margin-left: 10px;
    }

    .save-status.ok { color: var(--success); }
    .save-status.err { color: var(--danger); }

    /* â”€â”€â”€ Priority select â”€â”€â”€ */
    select.priority-sel {
      background: var(--surface);
      border: 1px solid var(--card-border);
      border-radius: 4px;
      color: var(--text);
      font-size: 11px;
      padding: 4px 8px;
      cursor: pointer;
      outline: none;
      margin-top: 6px;
    }

    select.priority-sel:focus { border-color: var(--accent); }

    /* â”€â”€â”€ Config table â”€â”€â”€ */
    .config-table { width: 100%; border-collapse: collapse; margin-bottom: 8px; }
    .config-table td {
      padding: 7px 10px;
      border-bottom: 1px solid rgba(255,255,255,0.04);
      font-size: 12px;
      word-break: break-all;
    }
    .config-table td:first-child {
      color: var(--text-dim);
      width: 180px;
      font-size: 11px;
      white-space: nowrap;
    }
    .config-table tr:last-child td { border-bottom: none; }
    .config-section-header {
      font-size: 12px;
      font-weight: 700;
      color: var(--accent);
      padding: 14px 10px 4px;
      text-transform: uppercase;
      letter-spacing: 0.8px;
    }

    /* â”€â”€â”€ System operation buttons â”€â”€â”€ */
    .system-btn {
      display: flex;
      align-items: center;
      gap: 14px;
      padding: 16px 18px;
      background: var(--surface);
      border: 1px solid var(--card-border);
      border-radius: 8px;
      margin-bottom: 12px;
      cursor: pointer;
      width: 100%;
      text-align: left;
      color: var(--text);
      font-size: 14px;
      font-weight: 500;
      transition: all 0.15s;
    }

    .system-btn:hover { border-color: var(--accent); background: rgba(124,92,191,0.08); }
    .system-btn.danger:hover { border-color: var(--danger); background: rgba(244,67,54,0.08); }
    .system-btn-icon { font-size: 22px; flex-shrink: 0; }
    .system-btn-desc { font-size: 11px; color: var(--text-dim); margin-top: 3px; }

    /* â”€â”€â”€ Draft modal â”€â”€â”€ */
    .modal-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.7);
      z-index: 200;
      align-items: center;
      justify-content: center;
    }

    .modal-overlay.open { display: flex; }

    .modal {
      background: var(--card);
      border: 1px solid var(--card-border);
      border-radius: 12px;
      padding: 24px;
      max-width: 560px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
    }

    .modal-title {
      font-weight: 600;
      margin-bottom: 12px;
    }

    .modal-body {
      white-space: pre-wrap;
      font-size: 13px;
      color: var(--text-dim);
      line-height: 1.6;
      margin-bottom: 16px;
      background: var(--surface);
      padding: 12px;
      border-radius: 6px;
    }

    .modal-close {
      background: var(--card-border);
      color: var(--text);
      border: none;
      padding: 7px 16px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 13px;
    }

    /* â”€â”€â”€ Toast â”€â”€â”€ */
    #toast {
      display: none;
      position: fixed;
      bottom: 24px;
      right: 24px;
      background: var(--card);
      border: 1px solid var(--card-border);
      border-radius: 8px;
      padding: 12px 18px;
      font-size: 13px;
      color: var(--text);
      z-index: 999;
      animation: fadeIn 0.3s ease;
    }

    /* â”€â”€â”€ Scrollbar â”€â”€â”€ */
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: var(--bg); }
    ::-webkit-scrollbar-thumb { background: var(--card-border); border-radius: 3px; }

    /* â”€â”€â”€ Task board / ã‚¿ã‚¹ã‚¯ãƒœãƒ¼ãƒ‰ â”€â”€â”€ */

    /* 3åˆ—ã‚°ãƒªãƒƒãƒ‰ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ / 3-column grid layout */
    .task-board {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 16px;
      margin-bottom: 20px;
    }

    /* å„åˆ—ã®ãƒ©ãƒƒãƒ‘ãƒ¼ / Column wrapper */
    .task-column {
      background: var(--card);
      border: 1px solid var(--card-border);
      border-radius: 10px;
      min-height: 200px;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    /* åˆ—ã”ã¨ã®ã‚¢ã‚¯ã‚»ãƒ³ãƒˆã‚«ãƒ©ãƒ¼ / Per-column accent color */
    .task-column.col-todo       { border-top: 2px solid var(--info); }
    .task-column.col-inprogress { border-top: 2px solid var(--warn); }
    .task-column.col-done       { border-top: 2px solid var(--success); }

    /* åˆ—ãƒ˜ãƒƒãƒ€ãƒ¼ / Column header */
    .task-col-header {
      display: flex;
      align-items: center;
      gap: 8px;
      font-weight: 600;
      font-size: 13px;
      padding: 12px 14px;
      border-bottom: 1px solid var(--card-border);
      color: var(--text);
    }

    /* åˆ—ãƒ˜ãƒƒãƒ€ãƒ¼å†…ã®ã‚«ã‚¦ãƒ³ãƒˆãƒãƒƒã‚¸ / Count badge inside column header */
    .task-col-count {
      margin-left: auto;
      background: var(--card-border);
      color: var(--text-dim);
      font-size: 10px;
      font-weight: 700;
      padding: 2px 7px;
      border-radius: 10px;
      min-width: 18px;
      text-align: center;
    }

    /* åˆ—ã®ã‚«ãƒ¼ãƒ‰ã‚³ãƒ³ãƒ†ãƒŠ / Card container inside column */
    .task-col-body {
      flex: 1;
      padding: 10px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      overflow-y: auto;
      max-height: 520px;
    }

    /* ã‚¿ã‚¹ã‚¯ã‚«ãƒ¼ãƒ‰ / Task card */
    .task-card {
      background: var(--surface);
      border: 1px solid var(--card-border);
      border-radius: 8px;
      padding: 11px 12px;
      cursor: pointer;
      transition: border-color 0.15s, background 0.15s;
    }

    .task-card:hover {
      border-color: var(--accent);
      background: rgba(124, 92, 191, 0.06);
    }

    /* ã‚«ãƒ¼ãƒ‰ä¸Šéƒ¨ï¼šå„ªå…ˆåº¦ãƒãƒƒã‚¸ + ã‚½ãƒ¼ã‚¹ã‚¢ã‚¤ã‚³ãƒ³ / Card top row: priority badge + source icon */
    .task-card-top {
      display: flex;
      align-items: center;
      gap: 6px;
      margin-bottom: 6px;
    }

    /* å„ªå…ˆåº¦ãƒãƒƒã‚¸ / Priority badge */
    .task-priority-badge {
      display: inline-block;
      padding: 1px 7px;
      border-radius: 4px;
      font-size: 10px;
      font-weight: 700;
      flex-shrink: 0;
    }

    /* å„ªå…ˆåº¦ã”ã¨ã®è‰² / Color per priority */
    .task-priority-badge.urgent { background: rgba(244, 67, 54, 0.2);  color: var(--danger); }
    .task-priority-badge.high   { background: rgba(255, 152, 0, 0.2);  color: var(--warn); }
    .task-priority-badge.medium { background: rgba(255, 193, 7, 0.15); color: #ffc107; }
    .task-priority-badge.low    { background: rgba(33, 150, 243, 0.2); color: var(--info); }

    /* ã‚½ãƒ¼ã‚¹ã‚¢ã‚¤ã‚³ãƒ³ / Source icon */
    .task-source-icon {
      margin-left: auto;
      font-size: 13px;
      flex-shrink: 0;
    }

    /* ã‚¿ã‚¹ã‚¯ã‚¿ã‚¤ãƒˆãƒ« / Task title */
    .task-title {
      font-size: 13px;
      font-weight: 500;
      line-height: 1.4;
      margin-bottom: 7px;
      color: var(--text);
      word-break: break-word;
    }

    /* æœŸæ—¥è¡¨ç¤º / Due date display */
    .task-date {
      font-size: 11px;
      color: var(--text-dim);
      margin-bottom: 8px;
    }

    /* æœŸæ—¥è¶…éãƒã‚¤ãƒ©ã‚¤ãƒˆ / Overdue highlight */
    .task-date.overdue {
      color: var(--danger);
      font-weight: 600;
    }

    /* ã‚«ãƒ¼ãƒ‰å†…ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ç¾¤ / Action buttons inside card */
    .task-actions {
      display: flex;
      gap: 5px;
      flex-wrap: wrap;
    }

    /* æ–°è¦ã‚¿ã‚¹ã‚¯ãƒ•ã‚©ãƒ¼ãƒ ã®è¡Œ / New task form row */
    .task-form-row {
      display: flex;
      gap: 10px;
      align-items: flex-end;
      flex-wrap: wrap;
    }

    .task-form-row .form-group {
      display: flex;
      flex-direction: column;
      gap: 5px;
    }

    .task-form-row .form-group label {
      font-size: 11px;
      color: var(--text-dim);
    }

    /* ãƒ•ã‚©ãƒ¼ãƒ ç”¨ã‚¤ãƒ³ãƒ—ãƒƒãƒˆï¼ˆsearch-bar ã‚’ç¶™æ‰¿ã—ã¤ã¤ margin ä¸Šæ›¸ãï¼‰*/
    /* Form input inheriting search-bar but overriding margin */
    .task-form-input {
      background: var(--surface);
      border: 1px solid var(--card-border);
      border-radius: 6px;
      color: var(--text);
      font-size: 13px;
      padding: 7px 11px;
      outline: none;
      width: 100%;
    }

    .task-form-input:focus { border-color: var(--accent); }
    .task-form-input::placeholder { color: var(--text-dim); }

    /* ãƒ•ã‚©ãƒ¼ãƒ ç”¨ã‚»ãƒ¬ã‚¯ãƒˆ / Form select */
    .task-form-select {
      background: var(--surface);
      border: 1px solid var(--card-border);
      border-radius: 6px;
      color: var(--text);
      font-size: 13px;
      padding: 7px 11px;
      cursor: pointer;
      outline: none;
    }

    .task-form-select:focus { border-color: var(--accent); }

    /* ã‚¿ã‚¹ã‚¯è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ«å†…ãƒ©ãƒ™ãƒ« / Label inside task detail modal */
    .task-modal-label {
      font-size: 11px;
      color: var(--text-dim);
      display: block;
      margin-bottom: 5px;
    }

    /* â”€â”€â”€ Expense view â”€â”€â”€ */

    /* Match badge for MoneyForward reconciliation status */
    .match-tag {
      display: inline-block;
      padding: 2px 7px;
      border-radius: 4px;
      font-size: 10px;
      font-weight: 700;
    }
    .match-tag.matched   { background: rgba(76,175,80,0.2);   color: var(--success); }
    .match-tag.unmatched { background: rgba(255,152,0,0.2);   color: var(--warn); }

    /* Payment method badge */
    .pm-tag {
      display: inline-block;
      padding: 2px 7px;
      border-radius: 4px;
      font-size: 10px;
      font-weight: 600;
      background: rgba(33,150,243,0.15);
      color: var(--info);
    }

    /* CSV upload drop zone */
    .upload-zone {
      border: 2px dashed var(--card-border);
      border-radius: 8px;
      padding: 20px;
      text-align: center;
      color: var(--text-dim);
      font-size: 13px;
      cursor: pointer;
      transition: border-color 0.2s;
      margin-bottom: 12px;
    }
    .upload-zone:hover { border-color: var(--accent); color: var(--text); }

    /* Category bar label row */
    .exp-bar-row {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 10px;
    }
    .exp-bar-label {
      min-width: 110px;
      font-size: 12px;
      color: var(--text-dim);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .exp-bar-amount {
      min-width: 80px;
      text-align: right;
      font-size: 12px;
      font-variant-numeric: tabular-nums;
    }
    .exp-bar-wrap {
      flex: 1;
      height: 6px;
      background: var(--card-border);
      border-radius: 3px;
      overflow: hidden;
    }
    .exp-bar-fill {
      height: 100%;
      border-radius: 3px;
      background: var(--accent);
    }

    /* Expense form inputs (reuse task-form-input style) */
    .exp-form-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 10px;
      margin-bottom: 12px;
    }
    .exp-form-group {
      display: flex;
      flex-direction: column;
      gap: 5px;
    }
    .exp-form-group label {
      font-size: 11px;
      color: var(--text-dim);
    }
  </style>
</head>
<body>

<!-- Header -->
<header>
  <div class="logo">â–Œ MY-<span>SECRETARY</span></div>
  <div class="status-badge">
    <div class="status-dot"></div>
    ç¨¼åƒä¸­
  </div>
  <div class="ws-status" style="margin-left:16px;">
    <div class="ws-dot" id="ws-dot"></div>
    <span id="ws-label">æœªæ¥ç¶š</span>
  </div>
  <div class="header-clock" id="clock">--:--:--</div>
</header>

<!-- Layout -->
<div class="layout">

  <!-- Sidebar -->
  <nav>
    <div class="nav-label">ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³</div>
    <div class="nav-item active" data-view="dashboard" onclick="showView('dashboard', this)">
      <span class="nav-icon">ğŸ“Š</span> ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰
    </div>
    <div class="nav-item" data-view="mail" onclick="showView('mail', this)">
      <span class="nav-icon">ğŸ“¬</span> ãƒ¡ãƒ¼ãƒ«
      <span class="badge warn" id="nav-pending-count">0</span>
    </div>
    <div class="nav-item" data-view="calendar" onclick="showView('calendar', this)">
      <span class="nav-icon">ğŸ“…</span> ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼
    </div>
    <div class="nav-item" data-view="contacts" onclick="showView('contacts', this)">
      <span class="nav-icon">ğŸ‘¥</span> é€£çµ¡å…ˆ
    </div>
    <!-- ã‚¿ã‚¹ã‚¯ãƒœãƒ¼ãƒ‰ / Task board -->
    <div class="nav-item" data-view="tasks" onclick="showView('tasks', this)">
      <span class="nav-icon">ğŸ“‹</span> ã‚¿ã‚¹ã‚¯
      <span class="badge" id="nav-tasks-count">0</span>
    </div>
    <!-- çµŒè²»ç®¡ç† / Expense management -->
    <div class="nav-item" data-view="expenses" onclick="showView('expenses', this)">
      <span class="nav-icon">ğŸ’°</span> çµŒè²»
    </div>
    <div class="nav-item" data-view="settings" onclick="showView('settings', this)">
      <span class="nav-icon">âš™ï¸</span> è¨­å®š
    </div>
  </nav>

  <!-- Main -->
  <main>

    <!-- â•â•â• ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ãƒ“ãƒ¥ãƒ¼ â•â•â• -->
    <div class="view" id="view-dashboard">
      <div class="view-title"><span>ğŸ“Š</span> ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</div>

      <!-- ä»Šæ—¥ã®æ¦‚è¦ -->
      <div class="stats-row">
        <div class="stat-item">
          <div class="stat-value success" id="stat-processed">0</div>
          <div class="stat-label">å‡¦ç†æ¸ˆã¿</div>
        </div>
        <div class="stat-item">
          <div class="stat-value warn" id="stat-pending">0</div>
          <div class="stat-label">æ‰¿èªå¾…ã¡</div>
        </div>
        <div class="stat-item">
          <div class="stat-value accent" id="stat-discord">0</div>
          <div class="stat-label">Discord é€šçŸ¥æ•°</div>
        </div>
      </div>

      <div class="grid-2">

        <!-- æ‰¿èªå¾…ã¡ãƒ¡ãƒ¼ãƒ« ã‚µãƒãƒªãƒ¼ -->
        <div class="card">
          <div class="card-header"><span class="icon">ğŸ“¬</span> æ‰¿èªå¾…ã¡ãƒ¡ãƒ¼ãƒ«</div>
          <div id="dash-pending-preview">
            <div class="empty-state"><div class="empty-icon">ğŸ“­</div>æ‰¿èªå¾…ã¡ãƒ¡ãƒ¼ãƒ«ã¯ã‚ã‚Šã¾ã›ã‚“</div>
          </div>
          <div style="margin-top:12px;">
            <div class="nav-item" style="margin:0;padding:8px 10px;justify-content:center;color:var(--accent);font-size:12px;"
                 onclick="showView('mail', document.querySelector('[data-view=mail]'))">
              ã™ã¹ã¦è¡¨ç¤º â†’
            </div>
          </div>
        </div>

        <!-- ä»Šæ—¥ã®äºˆå®š -->
        <div class="card">
          <div class="card-header"><span class="icon">ğŸ“…</span> ä»Šæ—¥ã®äºˆå®š</div>
          <div class="timeline" id="dash-calendar-timeline">
            <div class="empty-state"><div class="empty-icon">ğŸ“…</div>äºˆå®šã‚’èª­ã¿è¾¼ã¿ä¸­...</div>
          </div>
        </div>

        <!-- API ä½¿ç”¨é‡ -->
        <div class="card">
          <div class="card-header"><span class="icon">ğŸ“ˆ</span> API ä½¿ç”¨é‡</div>

          <div class="progress-label">
            <span>Gemini æ—¥æ¬¡ãƒªã‚¯ã‚¨ã‚¹ãƒˆ</span>
            <span id="gemini-daily-count">-- / 1500</span>
          </div>
          <div class="progress-bar">
            <div class="progress-fill" id="gemini-daily-bar" style="width:0%"></div>
          </div>

          <div class="progress-label">
            <span>Gemini åˆ†æ¬¡ãƒªã‚¯ã‚¨ã‚¹ãƒˆ</span>
            <span id="gemini-minute-count">-- / 15</span>
          </div>
          <div class="progress-bar">
            <div class="progress-fill" id="gemini-minute-bar" style="width:0%"></div>
          </div>

          <div id="api-remaining" style="font-size:12px;color:var(--text-dim);margin-top:4px;">
            æ®‹ã‚Š: --
          </div>
        </div>

        <!-- ãƒ©ã‚¤ãƒ–ãƒ•ã‚£ãƒ¼ãƒ‰ -->
        <div class="card">
          <div class="card-header"><span class="icon">ğŸ””</span> ãƒ©ã‚¤ãƒ–ãƒ•ã‚£ãƒ¼ãƒ‰</div>
          <div id="live-feed">
            <div class="empty-state"><div class="empty-icon">ğŸ””</div>ã‚¤ãƒ™ãƒ³ãƒˆå¾…æ©Ÿä¸­...</div>
          </div>
        </div>

      </div>
    </div><!-- /dashboard -->

    <!-- â•â•â• ãƒ¡ãƒ¼ãƒ«ãƒ“ãƒ¥ãƒ¼ â•â•â• -->
    <div class="view" id="view-mail" hidden>
      <div class="view-title"><span>ğŸ“¬</span> ãƒ¡ãƒ¼ãƒ«</div>

      <!-- æ¤œç´¢ãƒãƒ¼ -->
      <input type="text" class="search-bar" id="mail-search"
             placeholder="ä»¶åãƒ»é€ä¿¡è€…ã§æ¤œç´¢..."
             oninput="filterMailTable(this.value)">

      <!-- ã‚¿ãƒ–ãƒãƒ¼ -->
      <div class="tab-bar">
        <button class="tab-btn" data-tab="pending" onclick="fetchMailTab('pending')">
          æ‰¿èªå¾…ã¡ <span class="tab-badge" id="tab-count-pending">0</span>
        </button>
        <button class="tab-btn" data-tab="all" onclick="fetchMailTab('all')">
          å…¨ä»¶ <span class="tab-badge" id="tab-count-all">0</span>
        </button>
        <button class="tab-btn" data-tab="reply_needed" onclick="fetchMailTab('reply_needed')">
          è¦è¿”ä¿¡ <span class="tab-badge" id="tab-count-reply_needed">0</span>
        </button>
        <button class="tab-btn" data-tab="read_only" onclick="fetchMailTab('read_only')">
          é–²è¦§ã®ã¿ <span class="tab-badge" id="tab-count-read_only">0</span>
        </button>
        <button class="tab-btn" data-tab="rejected" onclick="fetchMailTab('rejected')">
          å´ä¸‹ <span class="tab-badge" id="tab-count-rejected">0</span>
        </button>
      </div>

      <!-- ãƒ¡ãƒ¼ãƒ«ãƒ†ãƒ¼ãƒ–ãƒ« -->
      <div class="card" style="padding:0;overflow:hidden;">
        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>æ—¥æ™‚</th>
                <th>é€ä¿¡è€…</th>
                <th>ä»¶å</th>
                <th>åˆ†é¡</th>
                <th>çŠ¶æ…‹</th>
                <th></th>
              </tr>
            </thead>
            <tbody id="mail-tbody">
              <tr><td colspan="6">
                <div class="empty-state"><div class="empty-icon">ğŸ“¬</div>ã‚¿ãƒ–ã‚’é¸æŠã—ã¦ãƒ¡ãƒ¼ãƒ«ã‚’è¡¨ç¤ºã—ã¾ã™</div>
              </td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div><!-- /mail -->

    <!-- â•â•â• ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãƒ“ãƒ¥ãƒ¼ â•â•â• -->
    <div class="view" id="view-calendar" hidden>
      <div class="view-title"><span>ğŸ“…</span> ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</div>
      <div class="card">
        <div class="card-header">
          <span class="icon">ğŸ“…</span>
          <span id="cal-date-label">ä»Šæ—¥ã®äºˆå®š</span>
        </div>
        <div class="timeline" id="cal-full-timeline">
          <div class="empty-state"><div class="empty-icon">ğŸ“…</div>äºˆå®šã‚’èª­ã¿è¾¼ã¿ä¸­...</div>
        </div>
      </div>
    </div><!-- /calendar -->

    <!-- â•â•â• é€£çµ¡å…ˆãƒ“ãƒ¥ãƒ¼ â•â•â• -->
    <div class="view" id="view-contacts" hidden>
      <div class="view-title"><span>ğŸ‘¥</span> é€£çµ¡å…ˆ</div>
      <div id="contacts-grid-wrap">
        <div class="empty-state"><div class="empty-icon">ğŸ‘¥</div>é€£çµ¡å…ˆã‚’èª­ã¿è¾¼ã¿ä¸­...</div>
      </div>
    </div><!-- /contacts -->

    <!-- â•â•â• ã‚¿ã‚¹ã‚¯ãƒœãƒ¼ãƒ‰ãƒ“ãƒ¥ãƒ¼ / Task board view â•â•â• -->
    <div class="view" id="view-tasks" hidden>
      <div class="view-title"><span>ğŸ“‹</span> ã‚¿ã‚¹ã‚¯</div>

      <!-- çµ±è¨ˆè¡Œ / Stats row -->
      <div class="stats-row">
        <div class="stat-item">
          <div class="stat-value accent" id="task-stat-total">0</div>
          <div class="stat-label">åˆè¨ˆ</div>
        </div>
        <div class="stat-item">
          <div class="stat-value info" id="task-stat-todo">0</div>
          <div class="stat-label">Todo</div>
        </div>
        <div class="stat-item">
          <div class="stat-value warn" id="task-stat-inprogress">0</div>
          <div class="stat-label">é€²è¡Œä¸­</div>
        </div>
        <div class="stat-item">
          <div class="stat-value success" id="task-stat-done">0</div>
          <div class="stat-label">å®Œäº†</div>
        </div>
        <div class="stat-item">
          <div class="stat-value danger" id="task-stat-overdue">0</div>
          <div class="stat-label">æœŸé™è¶…é</div>
        </div>
      </div>

      <!-- æ–°è¦ã‚¿ã‚¹ã‚¯ãƒ•ã‚©ãƒ¼ãƒ  / New task form -->
      <div class="card" style="margin-bottom:20px;">
        <div class="card-header"><span class="icon">â•</span> ã‚¿ã‚¹ã‚¯ã‚’è¿½åŠ </div>
        <div class="task-form-row">
          <!-- ã‚¿ã‚¤ãƒˆãƒ«å…¥åŠ› / Title input -->
          <div class="form-group" style="flex:2;min-width:200px;">
            <label>ã‚¿ã‚¤ãƒˆãƒ« / Title</label>
            <input type="text" id="new-task-title" class="task-form-input"
                   placeholder="ã‚¿ã‚¹ã‚¯ã®ã‚¿ã‚¤ãƒˆãƒ«ã‚’å…¥åŠ›..."
                   onkeydown="if(event.key==='Enter')createTask()">
          </div>
          <!-- æœŸæ—¥ / Due date -->
          <div class="form-group" style="flex:1;min-width:140px;">
            <label>æœŸæ—¥ / Due date</label>
            <input type="date" id="new-task-due" class="task-form-input">
          </div>
          <!-- å„ªå…ˆåº¦ / Priority -->
          <div class="form-group" style="min-width:130px;">
            <label>å„ªå…ˆåº¦ / Priority</label>
            <select id="new-task-priority" class="task-form-select">
              <option value="urgent">ğŸ”´ P1 ç·Šæ€¥</option>
              <option value="high">ğŸŸ  P2 é«˜</option>
              <option value="medium" selected>ğŸŸ¡ P3 ä¸­</option>
              <option value="low">ğŸ”µ P4 ä½</option>
            </select>
          </div>
          <!-- è¿½åŠ ãƒœã‚¿ãƒ³ / Add button -->
          <div class="form-group" style="justify-content:flex-end;">
            <label style="visibility:hidden;">-</label>
            <button class="btn btn-primary" onclick="createTask()" style="white-space:nowrap;">
              â• è¿½åŠ 
            </button>
          </div>
        </div>
      </div>

      <!-- 3åˆ—ã‚¿ã‚¹ã‚¯ãƒœãƒ¼ãƒ‰ / 3-column task board -->
      <div class="task-board">

        <!-- Todo åˆ— / Todo column -->
        <div class="task-column col-todo">
          <div class="task-col-header">
            <span>ğŸ“Œ Todo</span>
            <span class="task-col-count" id="col-todo-count">0</span>
          </div>
          <div class="task-col-body" id="col-todo-body">
            <div class="empty-state" style="padding:24px 16px;">
              <div class="empty-icon">ğŸ“­</div>ã‚¿ã‚¹ã‚¯ãªã—
            </div>
          </div>
        </div>

        <!-- In Progress åˆ— / In Progress column -->
        <div class="task-column col-inprogress">
          <div class="task-col-header">
            <span>â–¶ é€²è¡Œä¸­</span>
            <span class="task-col-count" id="col-inprogress-count">0</span>
          </div>
          <div class="task-col-body" id="col-inprogress-body">
            <div class="empty-state" style="padding:24px 16px;">
              <div class="empty-icon">ğŸ“­</div>ã‚¿ã‚¹ã‚¯ãªã—
            </div>
          </div>
        </div>

        <!-- Done åˆ— / Done column -->
        <div class="task-column col-done">
          <div class="task-col-header">
            <span>âœ… å®Œäº†</span>
            <span class="task-col-count" id="col-done-count">0</span>
          </div>
          <div class="task-col-body" id="col-done-body">
            <div class="empty-state" style="padding:24px 16px;">
              <div class="empty-icon">ğŸ“­</div>ã‚¿ã‚¹ã‚¯ãªã—
            </div>
          </div>
        </div>

      </div><!-- /task-board -->
    </div><!-- /tasks -->

    <!-- â•â•â• Expense management view â•â•â• -->
    <div class="view" id="view-expenses" hidden>
      <div class="view-title"><span>ğŸ’°</span> çµŒè²»ç®¡ç†</div>

      <!-- Stats row: current month totals -->
      <div class="stats-row">
        <div class="stat-item">
          <div class="stat-value accent" id="exp-stat-total">Â¥0</div>
          <div class="stat-label">ä»Šæœˆåˆè¨ˆ</div>
        </div>
        <div class="stat-item">
          <div class="stat-value info" id="exp-stat-count">0</div>
          <div class="stat-label">ä»¶æ•°</div>
        </div>
        <div class="stat-item">
          <div class="stat-value success" id="exp-stat-match">0%</div>
          <div class="stat-label">MF ç…§åˆç‡</div>
        </div>
      </div>

      <!-- Month selector + reload -->
      <div style="display:flex;align-items:center;gap:10px;margin-bottom:16px;">
        <input type="month" id="exp-month-picker" class="task-form-input"
               style="width:160px;" onchange="fetchExpenses()">
        <button class="btn btn-secondary" onclick="fetchExpenses()">â†º æ›´æ–°</button>
        <a id="exp-csv-link" href="#" class="btn btn-primary" style="text-decoration:none;" target="_blank">
          ğŸ“¥ å¹´æ¬¡ CSV
        </a>
      </div>

      <div class="grid-2">

        <!-- Category bar chart (CSS-only) -->
        <div class="card">
          <div class="card-header"><span class="icon">ğŸ“Š</span> ã‚«ãƒ†ã‚´ãƒªåˆ¥å†…è¨³</div>
          <div id="exp-chart-body">
            <div class="empty-state"><div class="empty-icon">ğŸ“Š</div>ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</div>
          </div>
        </div>

        <!-- Recent expenses table -->
        <div class="card" style="padding:0;overflow:hidden;">
          <div class="card-header" style="padding:16px 20px 0;">
            <span class="icon">ğŸ§¾</span> çµŒè²»ä¸€è¦§
          </div>
          <div class="table-wrap">
            <table>
              <thead>
                <tr>
                  <th>æ—¥ä»˜</th>
                  <th>åº—èˆ—å</th>
                  <th style="text-align:right;">é‡‘é¡</th>
                  <th>ã‚«ãƒ†ã‚´ãƒª</th>
                  <th>æ”¯æ‰•</th>
                  <th>MF</th>
                </tr>
              </thead>
              <tbody id="exp-tbody">
                <tr><td colspan="6">
                  <div class="empty-state"><div class="empty-icon">ğŸ’³</div>ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</div>
                </td></tr>
              </tbody>
            </table>
          </div>
        </div>

      </div><!-- /grid-2 -->

      <!-- MF CSV upload -->
      <div class="card" style="margin-bottom:16px;">
        <div class="card-header"><span class="icon">ğŸ“¥</span> MoneyForward CSV ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</div>
        <div class="upload-zone" id="exp-upload-zone" onclick="document.getElementById('exp-csv-file').click()">
          ã‚¯ãƒªãƒƒã‚¯ã¾ãŸã¯ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—ã§ CSV ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ
        </div>
        <input type="file" id="exp-csv-file" accept=".csv" style="display:none;" onchange="uploadMfCsv(this)">
        <div id="exp-upload-status" style="font-size:12px;color:var(--text-dim);"></div>
      </div>

      <!-- Manual expense entry form -->
      <div class="card">
        <div class="card-header"><span class="icon">â•</span> çµŒè²»ã‚’æ‰‹å‹•å…¥åŠ›</div>
        <div class="exp-form-row">
          <div class="exp-form-group">
            <label>æ—¥ä»˜</label>
            <input type="date" id="exp-new-date" class="task-form-input">
          </div>
          <div class="exp-form-group" style="flex:2;min-width:180px;">
            <label>åº—èˆ—åãƒ»å†…å®¹</label>
            <input type="text" id="exp-new-store" class="task-form-input" placeholder="ä¾‹: ã‚¹ã‚¿ãƒ¼ãƒãƒƒã‚¯ã‚¹">
          </div>
          <div class="exp-form-group">
            <label>é‡‘é¡ (å††)</label>
            <input type="number" id="exp-new-amount" class="task-form-input" placeholder="500" min="0">
          </div>
          <div class="exp-form-group">
            <label>å‹˜å®šç§‘ç›®</label>
            <select id="exp-new-category" class="task-form-select">
              <option value="">â”€â”€ é¸æŠ â”€â”€</option>
              <option>é€šä¿¡è²»</option>
              <option>æ—…è²»äº¤é€šè²»</option>
              <option>æ¶ˆè€—å“è²»</option>
              <option>æ¥å¾…äº¤éš›è²»</option>
              <option>ä¼šè­°è²»</option>
              <option>åœ°ä»£å®¶è³ƒ</option>
              <option>æ°´é“å…‰ç†±è²»</option>
              <option>åºƒå‘Šå®£ä¼è²»</option>
              <option>å¤–æ³¨è²»</option>
              <option>æ–°èå›³æ›¸è²»</option>
              <option>ç ”ä¿®è²»</option>
              <option>é›‘è²»</option>
            </select>
          </div>
          <div class="exp-form-group">
            <label>æ”¯æ‰•æ–¹æ³•</label>
            <select id="exp-new-pm" class="task-form-select">
              <option value="cash">ç¾é‡‘</option>
              <option value="credit_card">ã‚«ãƒ¼ãƒ‰</option>
              <option value="electronic">é›»å­ãƒãƒãƒ¼</option>
            </select>
          </div>
          <div class="exp-form-group" style="justify-content:flex-end;">
            <label style="visibility:hidden;">-</label>
            <button class="btn btn-primary" onclick="createExpense()">â• è¿½åŠ </button>
          </div>
        </div>
        <div class="exp-form-row">
          <div class="exp-form-group" style="grid-column:1/-1;">
            <label>ãƒ¡ãƒ¢ï¼ˆä»»æ„ï¼‰</label>
            <input type="text" id="exp-new-note" class="task-form-input" placeholder="è‡ªç”±è¨˜è¿°">
          </div>
        </div>
      </div>

    </div><!-- /expenses -->

    <!-- â•â•â• è¨­å®šãƒ“ãƒ¥ãƒ¼ â•â•â• -->
    <div class="view" id="view-settings" hidden>
      <div class="view-title"><span>âš™ï¸</span> è¨­å®š</div>

      <!-- è¨­å®šã‚¿ãƒ–ãƒãƒ¼ -->
      <div class="settings-tab-bar">
        <button class="settings-tab-btn active" data-stab="memory"   onclick="showSettingsTab('memory')">ğŸ“ MEMORY</button>
        <button class="settings-tab-btn"         data-stab="contacts" onclick="showSettingsTab('contacts')">ğŸ‘¥ é€£çµ¡å…ˆ</button>
        <button class="settings-tab-btn"         data-stab="config"   onclick="showSettingsTab('config')">âš™ï¸ è¨­å®šæƒ…å ±</button>
        <button class="settings-tab-btn"         data-stab="system"   onclick="showSettingsTab('system')">ğŸ”§ ã‚·ã‚¹ãƒ†ãƒ </button>
      </div>

      <!-- â”€â”€ MEMORY ã‚¿ãƒ– â”€â”€ -->
      <div class="settings-tab-content active" id="stab-memory">
        <div class="card">
          <div class="card-header"><span class="icon">ğŸ“</span> MEMORY.md ã‚¨ãƒ‡ã‚£ã‚¿</div>
          <label class="settings-label">ã‚·ã‚¹ãƒ†ãƒ ãƒ¡ãƒ¢ãƒªã®å†…å®¹ã‚’ç·¨é›†ã§ãã¾ã™ã€‚ä¿å­˜ã™ã‚‹ã¨å³åº§ã«åæ˜ ã•ã‚Œã¾ã™ã€‚</label>
          <textarea class="memory-editor" id="memory-editor" placeholder="MEMORY.md ã‚’èª­ã¿è¾¼ã¿ä¸­..."></textarea>
          <div style="margin-top:12px;display:flex;align-items:center;gap:8px;">
            <button class="btn btn-primary" onclick="saveMemory()">ğŸ’¾ ä¿å­˜</button>
            <button class="btn btn-secondary" onclick="loadMemory()">â†º ãƒªãƒ­ãƒ¼ãƒ‰</button>
            <span class="save-status" id="memory-status"></span>
          </div>
        </div>
      </div>

      <!-- â”€â”€ é€£çµ¡å…ˆ ã‚¿ãƒ– â”€â”€ -->
      <div class="settings-tab-content" id="stab-contacts">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:14px;">
          <span style="font-size:12px;color:var(--text-dim);">å„ªå…ˆåº¦ã‚’å¤‰æ›´ã™ã‚‹ã¨ contacts.md ã‚’å³åº§ã«æ›´æ–°ã—ã¾ã™</span>
          <button class="btn btn-secondary" style="font-size:11px;" onclick="refreshSettingsContacts()">â†º ãƒªãƒ­ãƒ¼ãƒ‰</button>
        </div>
        <div id="settings-contacts-wrap">
          <div class="empty-state"><div class="empty-icon">ğŸ‘¥</div>é€£çµ¡å…ˆã‚’èª­ã¿è¾¼ã¿ä¸­...</div>
        </div>
      </div>

      <!-- â”€â”€ è¨­å®šæƒ…å ± ã‚¿ãƒ– â”€â”€ -->
      <div class="settings-tab-content" id="stab-config">
        <div class="card">
          <div class="card-header"><span class="icon">âš™ï¸</span> è¨­å®šæƒ…å ±ï¼ˆèª­ã¿å–ã‚Šå°‚ç”¨ï¼‰</div>
          <p style="font-size:11px;color:var(--text-dim);margin-bottom:12px;">APIã‚­ãƒ¼ç­‰ã®æ©Ÿå¯†æƒ…å ±ã¯ãƒã‚¹ã‚¯ã•ã‚Œã¦ã„ã¾ã™</p>
          <div id="config-display">
            <div class="empty-state">èª­ã¿è¾¼ã¿ä¸­...</div>
          </div>
        </div>
      </div>

      <!-- â”€â”€ ã‚·ã‚¹ãƒ†ãƒ  ã‚¿ãƒ– â”€â”€ -->
      <div class="settings-tab-content" id="stab-system">
        <div class="card">
          <div class="card-header"><span class="icon">ğŸ”§</span> ã‚·ã‚¹ãƒ†ãƒ æ“ä½œ</div>

          <button class="system-btn" onclick="triggerCheck()">
            <span class="system-btn-icon">ğŸ”„</span>
            <div>
              <div>ãƒ¡ãƒ¼ãƒ«å†ãƒã‚§ãƒƒã‚¯å®Ÿè¡Œ</div>
              <div class="system-btn-desc">å®šæœŸãƒã‚§ãƒƒã‚¯å¾…æ©Ÿã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¦å³åº§ã«ãƒ¡ãƒ¼ãƒ«ãƒã‚§ãƒƒã‚¯ã‚’å®Ÿè¡Œã—ã¾ã™</div>
            </div>
          </button>

          <button class="system-btn danger" onclick="resetLearning()">
            <span class="system-btn-icon">ğŸ“Š</span>
            <div>
              <div>å­¦ç¿’ãƒ‡ãƒ¼ã‚¿ãƒªã‚»ãƒƒãƒˆ</div>
              <div class="system-btn-desc">contacts.md ã®è‡ªå‹•å­¦ç¿’æ¸ˆã¿é€£çµ¡å…ˆã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ï¼ˆå…ƒã«æˆ»ã›ã¾ã›ã‚“ï¼‰</div>
            </div>
          </button>
        </div>
      </div>

    </div><!-- /settings -->

  </main>
</div>

<!-- Task detail / edit modal / ã‚¿ã‚¹ã‚¯è©³ç´°ãƒ»ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="modal-overlay" id="task-modal">
  <div class="modal" style="max-width:480px;">
    <div class="modal-title">ğŸ“‹ ã‚¿ã‚¹ã‚¯è©³ç´°</div>

    <!-- ã‚¿ã‚¤ãƒˆãƒ«ç·¨é›† / Title edit -->
    <div style="margin-bottom:14px;">
      <label class="task-modal-label">ã‚¿ã‚¤ãƒˆãƒ« / Title</label>
      <input type="text" id="task-edit-title" class="task-form-input" placeholder="ã‚¿ã‚¹ã‚¯ã‚¿ã‚¤ãƒˆãƒ«">
    </div>

    <!-- æœŸæ—¥ + å„ªå…ˆåº¦ è¡Œ / Due date + priority row -->
    <div style="display:flex;gap:12px;margin-bottom:20px;">
      <div style="flex:1;">
        <label class="task-modal-label">æœŸæ—¥ / Due date</label>
        <input type="date" id="task-edit-due" class="task-form-input">
      </div>
      <div style="flex:1;">
        <label class="task-modal-label">å„ªå…ˆåº¦ / Priority</label>
        <select id="task-edit-priority" class="task-form-select" style="width:100%;">
          <option value="urgent">ğŸ”´ P1 ç·Šæ€¥</option>
          <option value="high">ğŸŸ  P2 é«˜</option>
          <option value="medium">ğŸŸ¡ P3 ä¸­</option>
          <option value="low">ğŸ”µ P4 ä½</option>
        </select>
      </div>
    </div>

    <!-- ãƒœã‚¿ãƒ³è¡Œ: å‰Šé™¤ï¼ˆå·¦ï¼‰ãƒ»ã‚­ãƒ£ãƒ³ã‚»ãƒ« + ä¿å­˜ï¼ˆå³ï¼‰/ Buttons: delete (left), cancel + save (right) -->
    <div style="display:flex;gap:8px;justify-content:space-between;align-items:center;">
      <button class="btn btn-reject" onclick="deleteTaskFromModal()">ğŸ—‘ï¸ å‰Šé™¤</button>
      <div style="display:flex;gap:8px;">
        <button class="modal-close" onclick="closeTaskModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button class="btn btn-primary" onclick="saveTaskEdit()">ğŸ’¾ ä¿å­˜</button>
      </div>
    </div>
  </div>
</div>

<!-- Draft modal -->
<div class="modal-overlay" id="draft-modal">
  <div class="modal">
    <div class="modal-title" id="modal-subject"></div>
    <div class="modal-body" id="modal-draft"></div>
    <button class="modal-close" onclick="closeModal()">é–‰ã˜ã‚‹</button>
  </div>
</div>

<!-- Toast -->
<div id="toast"></div>

<script>
  // â”€â”€â”€ çŠ¶æ…‹ â”€â”€â”€
  let _pendingEmails = [];
  let _lastStatus = {};
  let _contactsLoaded = false;
  let _memoryLoaded = false;
  let _currentMailTab = null;
  let _mailEmails = [];
  let _mailSearchText = '';
  let _settingsContactsLoaded = false;
  let _settingsConfigLoaded = false;

  // â”€â”€â”€ æ™‚è¨ˆ â”€â”€â”€
  function updateClock() {
    const now = new Date();
    document.getElementById('clock').textContent =
      now.toLocaleTimeString('ja-JP', { hour12: false });
  }
  setInterval(updateClock, 1000);
  updateClock();

  // â”€â”€â”€ ãƒ“ãƒ¥ãƒ¼åˆ‡æ›¿ â”€â”€â”€
  function showView(id, navEl) {
    document.querySelectorAll('.view').forEach(v => v.hidden = true);
    const target = document.getElementById('view-' + id);
    if (target) target.hidden = false;

    document.querySelectorAll('.nav-item[data-view]').forEach(n => n.classList.remove('active'));
    if (navEl) navEl.classList.add('active');

    if (id === 'contacts' && !_contactsLoaded) {
      fetchContacts();
    }
    if (id === 'settings' && !_memoryLoaded) {
      loadMemory();
    }
    if (id === 'calendar') {
      updateCalDate();
    }
    if (id === 'mail') {
      fetchMailTab(_currentMailTab || 'pending');
    }
    // ã‚¿ã‚¹ã‚¯ãƒ“ãƒ¥ãƒ¼ã‚’åˆã‚ã¦é–‹ã„ãŸã¨ãã«ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã™ã‚‹
    // Fetch task data the first time the tasks view is opened
    if (id === 'tasks') {
      fetchTasks();
      fetchTaskStats();
    }
  }

  // â”€â”€â”€ ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒãƒ¼ãƒªãƒ³ã‚° (5ç§’) â”€â”€â”€
  async function fetchStatus() {
    try {
      const res = await fetch('/api/status');
      if (!res.ok) return;
      const data = await res.json();
      _lastStatus = data;
      _pendingEmails = data.pending_emails || [];

      document.getElementById('stat-processed').textContent = data.processed_count || 0;
      document.getElementById('stat-pending').textContent = data.pending_count || 0;
      document.getElementById('stat-discord').textContent = data.discord_count || 0;
      document.getElementById('nav-pending-count').textContent = data.pending_count || 0;

      renderDashPendingPreview(data.pending_emails || []);
      renderTimelineIn('dash-calendar-timeline', data.today_events || [], false);
      renderTimelineIn('cal-full-timeline', data.today_events || [], true);

      // æ‰¿èªå¾…ã¡ã‚¿ãƒ–ãŒè¡¨ç¤ºä¸­ã®å ´åˆã¯ã‚«ã‚¦ãƒ³ãƒˆãƒãƒƒã‚¸ã‚’æ›´æ–°
      const countEl = document.getElementById('tab-count-pending');
      if (countEl) countEl.textContent = data.pending_count || 0;

    } catch (e) {
      console.warn('fetchStatus error', e);
    }
  }

  // â”€â”€â”€ API ä½¿ç”¨é‡ãƒãƒ¼ãƒªãƒ³ã‚° (30ç§’) â”€â”€â”€
  async function fetchApiUsage() {
    try {
      const res = await fetch('/api/api-usage');
      if (!res.ok) return;
      const data = await res.json();
      renderApiUsage(data.realtime || {});
    } catch (e) {
      console.warn('fetchApiUsage error', e);
    }
  }

  function renderApiUsage(realtime) {
    const dailyCount  = realtime.daily_count  || 0;
    const dailyRemain = realtime.daily_remaining != null ? realtime.daily_remaining : (1500 - dailyCount);
    const minuteCount = realtime.minute_count || 0;

    const dailyLimit  = 1500;
    const minuteLimit = 15;

    const dailyPct  = Math.min(100, Math.round(dailyCount  / dailyLimit  * 100));
    const minutePct = Math.min(100, Math.round(minuteCount / minuteLimit * 100));

    document.getElementById('gemini-daily-count').textContent  = `${dailyCount} / ${dailyLimit}`;
    document.getElementById('gemini-minute-count').textContent = `${minuteCount} / ${minuteLimit}`;
    document.getElementById('api-remaining').textContent       = `æ®‹ã‚Š: ${dailyRemain} ãƒªã‚¯ã‚¨ã‚¹ãƒˆ / æ—¥`;

    const dbar = document.getElementById('gemini-daily-bar');
    dbar.style.width = dailyPct + '%';
    dbar.className = 'progress-fill' + (dailyPct > 80 ? ' danger' : dailyPct > 50 ? ' warn' : '');

    const mbar = document.getElementById('gemini-minute-bar');
    mbar.style.width = minutePct + '%';
    mbar.className = 'progress-fill' + (minutePct > 80 ? ' danger' : minutePct > 50 ? ' warn' : '');
  }

  // â”€â”€â”€ ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰: æ‰¿èªå¾…ã¡ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ â”€â”€â”€
  function renderDashPendingPreview(emails) {
    const el = document.getElementById('dash-pending-preview');
    if (!emails.length) {
      el.innerHTML = `<div class="empty-state"><div class="empty-icon">ğŸ“­</div>æ‰¿èªå¾…ã¡ãƒ¡ãƒ¼ãƒ«ã¯ã‚ã‚Šã¾ã›ã‚“</div>`;
      return;
    }
    const preview = emails.slice(0, 3);
    el.innerHTML = `
      <div style="font-size:12px;color:var(--text-dim);margin-bottom:8px;">${emails.length} ä»¶ã®æ‰¿èªå¾…ã¡</div>
      ${preview.map(m => `
        <div class="pending-preview-item">
          <div class="pending-preview-subject">${esc(m.subject)}</div>
          <div class="pending-preview-sender">${esc(m.sender)}</div>
        </div>
      `).join('')}
      ${emails.length > 3 ? `<div style="font-size:11px;color:var(--text-dim);padding-top:8px;">ä»– ${emails.length - 3} ä»¶...</div>` : ''}
    `;
  }

  // â”€â”€â”€ ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³æç”» â”€â”€â”€
  function renderTimelineIn(elId, events, showAttendees) {
    const el = document.getElementById(elId);
    if (!el) return;
    if (!events.length) {
      el.innerHTML = `<div class="empty-state"><div class="empty-icon">ğŸ“…</div>ä»Šæ—¥ã®äºˆå®šã¯ã‚ã‚Šã¾ã›ã‚“</div>`;
      return;
    }
    el.innerHTML = events.map(ev => {
      const attendeeSub = (showAttendees && ev.attendees && ev.attendees.length > 1)
        ? `<div class="timeline-sub">ğŸ‘¥ å‚åŠ è€… ${ev.attendees.length}å</div>` : '';
      return `
        <div class="timeline-item">
          <div class="timeline-time">${ev.is_all_day ? 'çµ‚æ—¥' : (ev.start || '--:--')}</div>
          <div class="timeline-dot ${ev.is_all_day ? 'allday' : ''}"></div>
          <div class="timeline-content">
            <div class="timeline-title">${esc(ev.title)}</div>
            ${ev.location ? `<div class="timeline-sub">ğŸ“ ${esc(ev.location)}</div>` : ''}
            ${!ev.is_all_day && ev.end ? `<div class="timeline-sub">ã€œ ${ev.end}</div>` : ''}
            ${attendeeSub}
          </div>
        </div>
      `;
    }).join('');
  }

  // â”€â”€â”€ ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãƒ“ãƒ¥ãƒ¼æ—¥ä»˜ãƒ©ãƒ™ãƒ« â”€â”€â”€
  function updateCalDate() {
    const today = new Date();
    const label = today.toLocaleDateString('ja-JP', { year:'numeric', month:'long', day:'numeric', weekday:'short' });
    document.getElementById('cal-date-label').textContent = label + ' ã®äºˆå®š';
  }

  // â”€â”€â”€ ã‚«ãƒ†ã‚´ãƒªã‚¿ã‚° â”€â”€â”€
  function getCategoryTag(cat) {
    const map = {
      'urgent': ['urgent', 'ç·Šæ€¥'],
      'normal': ['normal', 'é€šå¸¸'],
      'info':   ['info-tag', 'æƒ…å ±'],
      'spam':   ['spam', 'ã‚¹ãƒ‘ãƒ '],
    };
    const [cls, rawLabel] = map[cat] || ['info-tag', cat || '-'];
    const label = esc(rawLabel);
    return `<span class="category-tag ${cls}">${label}</span>`;
  }

  // â”€â”€â”€ çŠ¶æ…‹ã‚¿ã‚° â”€â”€â”€
  function getStatusTag(status) {
    const map = {
      'pending':   ['pending',   'æ‰¿èªå¾…ã¡'],
      'approved':  ['approved',  'é€ä¿¡æ¸ˆã¿'],
      'rejected':  ['rejected',  'å´ä¸‹'],
      'read_only': ['read_only', 'é–²è¦§ã®ã¿'],
    };
    const [cls, rawLabel] = map[status] || ['pending', status || '-'];
    const label = esc(rawLabel);
    return `<span class="status-tag ${cls}">${label}</span>`;
  }

  // â”€â”€â”€ ãƒ¡ãƒ¼ãƒ«ã‚¿ãƒ–å–å¾— â”€â”€â”€
  async function fetchMailTab(tab) {
    _currentMailTab = tab;
    _mailSearchText = document.getElementById('mail-search')?.value || '';

    document.querySelectorAll('[data-tab]').forEach(btn => {
      btn.classList.toggle('active', btn.dataset.tab === tab);
    });

    const tbody = document.getElementById('mail-tbody');
    if (tbody) {
      tbody.innerHTML = `<tr><td colspan="6"><div class="empty-state">èª­ã¿è¾¼ã¿ä¸­...</div></td></tr>`;
    }

    try {
      let emails = [];

      if (tab === 'pending') {
        const res = await fetch('/api/emails/pending');
        if (res.ok) emails = await res.json();
      } else if (tab === 'all') {
        const res = await fetch('/api/emails');
        if (res.ok) emails = await res.json();
      } else if (tab === 'reply_needed') {
        const res = await fetch('/api/emails');
        if (res.ok) {
          const all = await res.json();
          emails = all.filter(m => m.category === 'urgent' || m.category === 'normal');
        }
      } else if (tab === 'read_only') {
        const res = await fetch('/api/emails?status=read_only');
        if (res.ok) emails = await res.json();
      } else if (tab === 'rejected') {
        const res = await fetch('/api/emails?status=rejected');
        if (res.ok) emails = await res.json();
      }

      _mailEmails = emails;
      const countEl = document.getElementById('tab-count-' + tab);
      if (countEl) countEl.textContent = emails.length;

      const searchVal = document.getElementById('mail-search')?.value || '';
      const toRender = searchVal
        ? emails.filter(m =>
            (m.subject || '').toLowerCase().includes(searchVal.toLowerCase()) ||
            (m.sender  || '').toLowerCase().includes(searchVal.toLowerCase()))
        : emails;
      renderMailTable(toRender);

    } catch (e) {
      console.warn('fetchMailTab error', e);
      if (tbody) {
        tbody.innerHTML = `<tr><td colspan="6"><div class="empty-state">èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</div></td></tr>`;
      }
    }
  }

  function filterMailTable(searchText) {
    _mailSearchText = searchText;
    if (!_mailEmails.length) return;
    const lower = searchText.toLowerCase();
    const filtered = lower
      ? _mailEmails.filter(m =>
          (m.subject || '').toLowerCase().includes(lower) ||
          (m.sender  || '').toLowerCase().includes(lower))
      : _mailEmails;
    renderMailTable(filtered);
  }

  function renderMailTable(emails) {
    const tbody = document.getElementById('mail-tbody');
    if (!tbody) return;

    if (!emails.length) {
      tbody.innerHTML = `<tr><td colspan="6">
        <div class="empty-state"><div class="empty-icon">ğŸ“­</div>ãƒ¡ãƒ¼ãƒ«ãŒã‚ã‚Šã¾ã›ã‚“</div>
      </td></tr>`;
      return;
    }

    const isPendingTab = _currentMailTab === 'pending';

    tbody.innerHTML = emails.map(m => {
      // pending ã‚¿ãƒ–ã¯ /api/emails/pending ã‹ã‚‰è¿”ã‚‹ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ï¼ˆid, subject, sender, category, draft, body_previewï¼‰
      // DB ã‚¿ãƒ–ã¯ DB ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ï¼ˆmessage_id, subject, sender, category, reply_draft, body_preview, status, created_atï¼‰
      const id         = m.id || m.message_id || '';
      const subject    = m.subject    || '';
      const sender     = m.sender     || '';
      const category   = m.category   || '';
      const status     = m.status     || (isPendingTab ? 'pending' : '');
      const draft      = m.draft      !== undefined ? m.draft      : (m.reply_draft || '');
      const preview    = m.body_preview || '';
      const dateStr    = m.created_at ? m.created_at.slice(0, 16).replace('T', ' ') : (m.date || '');

      const isActionable = isPendingTab || status === 'pending';
      const draftReadonly = isActionable ? '' : 'readonly';

      const actionBtns = isActionable ? `
        <div class="btn-group" style="margin-top:10px;">
          <button class="btn" style="font-size:11px;background:rgba(124,92,191,0.2);color:var(--accent);border:1px solid rgba(124,92,191,0.3);"
              onclick="saveEditedDraft('${esc(id)}');event.stopPropagation()">âœï¸ ä¿å­˜</button>
          <button class="btn btn-approve"
              onclick="saveAndApprove('${esc(id)}');event.stopPropagation()">âœ… æ‰¿èª</button>
          <button class="btn btn-reject"
              onclick="rejectMail('${esc(id)}');event.stopPropagation()">âŒ å´ä¸‹</button>
          <button class="btn btn-secondary" style="font-size:11px;"
              onclick="dismissMail('${esc(id)}');event.stopPropagation()">ğŸ“– é–²è¦§ã®ã¿</button>
        </div>
      ` : '';

      return `
        <tr id="row-${esc(id)}" class="mail-row" onclick="toggleAccordion('${esc(id)}')">
          <td style="font-size:11px;color:var(--text-dim);white-space:nowrap;">${esc(dateStr)}</td>
          <td style="max-width:130px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;font-size:12px;"
              title="${esc(sender)}">${esc(sender)}</td>
          <td class="subject-cell" title="${esc(subject)}">${esc(subject)}</td>
          <td>${getCategoryTag(category)}</td>
          <td>${getStatusTag(status)}</td>
          <td style="text-align:center;"><span class="expand-arrow">â–¼</span></td>
        </tr>
        <tr id="detail-${esc(id)}" class="accordion-detail">
          <td colspan="6">
            <div style="padding:12px 16px;">
              ${preview ? `<div class="body-preview">${esc(preview)}</div>` : ''}
              ${draft !== '' || isActionable ? `
                <div style="margin-top:8px;font-size:11px;color:var(--text-dim);">è¿”ä¿¡æ¡ˆ</div>
                <textarea class="draft-ta" id="draft-ta-${esc(id)}" ${draftReadonly}>${esc(draft)}</textarea>
                ${actionBtns}
              ` : ''}
            </div>
          </td>
        </tr>
      `;
    }).join('');
  }

  function toggleAccordion(id) {
    const detail = document.getElementById('detail-' + id);
    const row    = document.getElementById('row-'    + id);
    if (!detail) return;
    const isOpen = detail.classList.contains('open');

    // ä»–ã®ã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³ã‚’é–‰ã˜ã‚‹
    document.querySelectorAll('.accordion-detail.open').forEach(el => {
      el.classList.remove('open');
      const sibRow = document.getElementById('row-' + el.id.replace('detail-', ''));
      if (sibRow) sibRow.classList.remove('expanded');
    });

    if (!isOpen) {
      detail.classList.add('open');
      if (row) row.classList.add('expanded');
    }
  }

  // â”€â”€â”€ è¿”ä¿¡æ¡ˆã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ç·¨é›† â”€â”€â”€
  async function saveEditedDraft(emailId) {
    const ta = document.getElementById('draft-ta-' + emailId);
    if (!ta) return;
    try {
      const res = await fetch('/api/emails/' + encodeURIComponent(emailId) + '/edit-reply', {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ draft: ta.value }),
      });
      if (res.ok) {
        showToast('âœï¸ è¿”ä¿¡æ¡ˆã‚’ä¿å­˜ã—ã¾ã—ãŸ');
      } else {
        const d = await res.json();
        alert('ä¿å­˜ã‚¨ãƒ©ãƒ¼: ' + (d.detail || 'å¤±æ•—'));
      }
    } catch (e) {
      alert('ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼: ' + e);
    }
  }

  async function saveAndApprove(emailId) {
    const ta = document.getElementById('draft-ta-' + emailId);
    if (ta) {
      try {
        await fetch('/api/emails/' + encodeURIComponent(emailId) + '/edit-reply', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ draft: ta.value }),
        });
      } catch (e) {}
    }
    await approveMail(emailId);
  }

  // â”€â”€â”€ æ‰¿èª / å´ä¸‹ / é–²è¦§ã®ã¿ â”€â”€â”€
  async function approveMail(emailId) {
    const row    = document.getElementById('row-'    + emailId);
    const detail = document.getElementById('detail-' + emailId);
    if (!row) return;
    const btns = row.querySelectorAll('.btn');
    btns.forEach(b => b.disabled = true);

    try {
      const res = await fetch('/api/approve/' + encodeURIComponent(emailId), { method: 'POST' });
      const data = await res.json();
      if (!res.ok) {
        alert('ã‚¨ãƒ©ãƒ¼: ' + (data.detail || 'é€ä¿¡å¤±æ•—'));
        btns.forEach(b => b.disabled = false);
        return;
      }
      row.classList.add('removing');
      setTimeout(() => {
        row.remove();
        if (detail) detail.remove();
        fetchStatus();
        if (_currentMailTab) fetchMailTab(_currentMailTab);
      }, 300);
    } catch (e) {
      alert('ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼: ' + e);
      btns.forEach(b => b.disabled = false);
    }
  }

  async function rejectMail(emailId) {
    if (!confirm('ã“ã®ãƒ¡ãƒ¼ãƒ«ã®è¿”ä¿¡æ¡ˆã‚’å´ä¸‹ã—ã¾ã™ã‹ï¼Ÿ')) return;
    const row    = document.getElementById('row-'    + emailId);
    const detail = document.getElementById('detail-' + emailId);
    if (!row) return;
    const btns = row.querySelectorAll('.btn');
    btns.forEach(b => b.disabled = true);

    try {
      const res = await fetch('/api/reject/' + encodeURIComponent(emailId), { method: 'POST' });
      if (!res.ok) {
        const data = await res.json();
        alert('ã‚¨ãƒ©ãƒ¼: ' + (data.detail || 'å´ä¸‹å¤±æ•—'));
        btns.forEach(b => b.disabled = false);
        return;
      }
      row.classList.add('removing');
      setTimeout(() => {
        row.remove();
        if (detail) detail.remove();
        fetchStatus();
        if (_currentMailTab) fetchMailTab(_currentMailTab);
      }, 300);
    } catch (e) {
      alert('ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼: ' + e);
      btns.forEach(b => b.disabled = false);
    }
  }

  async function dismissMail(emailId) {
    const row    = document.getElementById('row-'    + emailId);
    const detail = document.getElementById('detail-' + emailId);
    try {
      const res = await fetch('/api/emails/' + encodeURIComponent(emailId) + '/dismiss', { method: 'POST' });
      if (!res.ok) {
        const d = await res.json();
        alert('ã‚¨ãƒ©ãƒ¼: ' + (d.detail || 'å¤±æ•—'));
        return;
      }
      if (row) {
        row.classList.add('removing');
        setTimeout(() => {
          row.remove();
          if (detail) detail.remove();
          fetchStatus();
          if (_currentMailTab) fetchMailTab(_currentMailTab);
        }, 300);
      }
    } catch (e) {
      alert('ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼: ' + e);
    }
  }

  // â”€â”€â”€ Draft ãƒ¢ãƒ¼ãƒ€ãƒ« â”€â”€â”€
  function showDraft(emailId, subject, draft) {
    document.getElementById('modal-subject').textContent = subject;
    document.getElementById('modal-draft').textContent = draft;
    document.getElementById('draft-modal').classList.add('open');
  }

  function closeModal() {
    document.getElementById('draft-modal').classList.remove('open');
  }

  document.getElementById('draft-modal').addEventListener('click', function(e) {
    if (e.target === this) closeModal();
  });

  // â”€â”€â”€ é€£çµ¡å…ˆï¼ˆé€£çµ¡å…ˆãƒ“ãƒ¥ãƒ¼ï¼‰ â”€â”€â”€
  async function fetchContacts() {
    try {
      const res = await fetch('/api/contacts');
      if (!res.ok) return;
      const data = await res.json();
      renderContacts(data.contacts || {});
      _contactsLoaded = true;
    } catch (e) {
      console.warn('fetchContacts error', e);
    }
  }

  function renderContacts(contacts) {
    const wrap = document.getElementById('contacts-grid-wrap');
    const entries = Object.entries(contacts);
    if (!entries.length) {
      wrap.innerHTML = `<div class="empty-state"><div class="empty-icon">ğŸ‘¥</div>é€£çµ¡å…ˆãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</div>`;
      return;
    }

    wrap.innerHTML = `<div class="contacts-grid">` +
      entries.map(([name, info]) => {
        const priority = info.priority || 'low';
        const pBadge = {
          'é«˜': 'high', 'ä¸­': 'medium', 'ä½': 'low',
          'high': 'high', 'medium': 'medium', 'low': 'low',
        }[priority] || 'low';
        const pLabel = { 'high': 'å„ªå…ˆ: é«˜', 'medium': 'å„ªå…ˆ: ä¸­', 'low': 'å„ªå…ˆ: ä½' }[pBadge];
        return `
          <div class="contact-card">
            <div class="contact-name">${esc(name)}</div>
            <div class="contact-email">${esc(info.email || '-')}</div>
            <span class="priority-badge ${pBadge}">${esc(pLabel)}</span>
          </div>
        `;
      }).join('') +
    `</div>`;
  }

  // â”€â”€â”€ MEMORY.md è¨­å®š â”€â”€â”€
  async function loadMemory() {
    const ta = document.getElementById('memory-editor');
    const st = document.getElementById('memory-status');
    st.textContent = 'èª­ã¿è¾¼ã¿ä¸­...';
    st.className = 'save-status';
    try {
      const res = await fetch('/api/memory');
      if (!res.ok) throw new Error(res.status);
      const data = await res.json();
      ta.value = data.content || '';
      st.textContent = 'èª­ã¿è¾¼ã¿å®Œäº†';
      st.className = 'save-status ok';
      _memoryLoaded = true;
      setTimeout(() => { st.textContent = ''; }, 2000);
    } catch (e) {
      st.textContent = 'èª­ã¿è¾¼ã¿å¤±æ•—: ' + e;
      st.className = 'save-status err';
    }
  }

  async function saveMemory() {
    const ta = document.getElementById('memory-editor');
    const st = document.getElementById('memory-status');
    st.textContent = 'ä¿å­˜ä¸­...';
    st.className = 'save-status';
    try {
      const res = await fetch('/api/memory', {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ content: ta.value }),
      });
      if (!res.ok) throw new Error(res.status);
      st.textContent = 'âœ… ä¿å­˜ã—ã¾ã—ãŸ';
      st.className = 'save-status ok';
      setTimeout(() => { st.textContent = ''; }, 3000);
    } catch (e) {
      st.textContent = 'âŒ ä¿å­˜å¤±æ•—: ' + e;
      st.className = 'save-status err';
    }
  }

  // â”€â”€â”€ è¨­å®šã‚¿ãƒ–åˆ‡æ›¿ â”€â”€â”€
  function showSettingsTab(tab) {
    document.querySelectorAll('[data-stab]').forEach(btn => {
      btn.classList.toggle('active', btn.dataset.stab === tab);
    });
    document.querySelectorAll('.settings-tab-content').forEach(el => {
      el.classList.toggle('active', el.id === 'stab-' + tab);
    });

    if (tab === 'contacts' && !_settingsContactsLoaded) {
      fetchSettingsContacts();
    }
    if (tab === 'config' && !_settingsConfigLoaded) {
      fetchConfig();
    }
  }

  // â”€â”€â”€ è¨­å®šã‚¿ãƒ–: é€£çµ¡å…ˆ â”€â”€â”€
  async function fetchSettingsContacts() {
    try {
      const res = await fetch('/api/contacts');
      if (!res.ok) return;
      const data = await res.json();
      renderSettingsContacts(data.contacts || {});
      _settingsContactsLoaded = true;
    } catch (e) {
      console.warn('fetchSettingsContacts error', e);
    }
  }

  function refreshSettingsContacts() {
    _settingsContactsLoaded = false;
    document.getElementById('settings-contacts-wrap').innerHTML =
      `<div class="empty-state"><div class="empty-icon">ğŸ‘¥</div>é€£çµ¡å…ˆã‚’èª­ã¿è¾¼ã¿ä¸­...</div>`;
    fetchSettingsContacts();
  }

  function renderSettingsContacts(contacts) {
    const wrap = document.getElementById('settings-contacts-wrap');
    const entries = Object.entries(contacts);
    if (!entries.length) {
      wrap.innerHTML = `<div class="empty-state"><div class="empty-icon">ğŸ‘¥</div>é€£çµ¡å…ˆãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</div>`;
      return;
    }

    wrap.innerHTML = `<div class="contacts-grid">` +
      entries.map(([name, info]) => {
        const priority = info.priority || 'ä¸­';
        const pBadge = { 'é«˜': 'high', 'ä¸­': 'medium', 'ä½': 'low',
                         'high': 'high', 'medium': 'medium', 'low': 'low' }[priority] || 'medium';
        const pVal   = { 'high': 'é«˜', 'medium': 'ä¸­', 'low': 'ä½' }[pBadge] || 'ä¸­';
        const emailAddr = info.email || name;
        return `
          <div class="contact-card">
            <div class="contact-name">${esc(name)}</div>
            <div class="contact-email">${esc(emailAddr)}</div>
            <select class="priority-sel"
                    onchange="updateContactPriority('${esc(emailAddr)}', this.value)">
              <option value="é«˜" ${pVal === 'é«˜' ? 'selected' : ''}>é«˜å„ªå…ˆ</option>
              <option value="ä¸­" ${pVal === 'ä¸­' ? 'selected' : ''}>ä¸­å„ªå…ˆ</option>
              <option value="ä½" ${pVal === 'ä½' ? 'selected' : ''}>ä½å„ªå…ˆ</option>
            </select>
          </div>
        `;
      }).join('') +
    `</div>`;
  }

  async function updateContactPriority(email, priority) {
    try {
      const res = await fetch('/api/contacts/' + encodeURIComponent(email) + '/priority', {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ priority }),
      });
      if (res.ok) {
        showToast('âœ… å„ªå…ˆåº¦ã‚’æ›´æ–°ã—ã¾ã—ãŸ: ' + priority);
      } else {
        const d = await res.json();
        alert('ã‚¨ãƒ©ãƒ¼: ' + (d.detail || 'æ›´æ–°å¤±æ•—'));
      }
    } catch (e) {
      alert('ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼: ' + e);
    }
  }

  // â”€â”€â”€ è¨­å®šã‚¿ãƒ–: è¨­å®šæƒ…å ± â”€â”€â”€
  async function fetchConfig() {
    const el = document.getElementById('config-display');
    if (!el) return;
    try {
      const res = await fetch('/api/config');
      if (!res.ok) throw new Error(res.status);
      const data = await res.json();
      renderConfig(data);
      _settingsConfigLoaded = true;
    } catch (e) {
      el.innerHTML = `<div class="empty-state">è¨­å®šã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</div>`;
    }
  }

  function renderConfig(data) {
    const el = document.getElementById('config-display');
    if (!el) return;

    function renderRows(obj) {
      return Object.entries(obj).map(([k, v]) => {
        const val = (typeof v === 'object' && v !== null) ? JSON.stringify(v) : String(v ?? '');
        return `<tr><td>${esc(k)}</td><td>${esc(val)}</td></tr>`;
      }).join('');
    }

    let html = '';
    for (const [key, val] of Object.entries(data)) {
      if (typeof val === 'object' && val !== null) {
        html += `<div class="config-section-header">${esc(key)}</div>
                 <table class="config-table"><tbody>${renderRows(val)}</tbody></table>`;
      } else {
        html += `<table class="config-table"><tbody>
                   <tr><td>${esc(key)}</td><td>${esc(String(val ?? ''))}</td></tr>
                 </tbody></table>`;
      }
    }
    el.innerHTML = html || '<div class="empty-state">è¨­å®šãªã—</div>';
  }

  // â”€â”€â”€ è¨­å®šã‚¿ãƒ–: ã‚·ã‚¹ãƒ†ãƒ  â”€â”€â”€
  async function triggerCheck() {
    try {
      const res = await fetch('/api/trigger-check', { method: 'POST' });
      if (res.ok) {
        showToast('ğŸ”„ ãƒ¡ãƒ¼ãƒ«ãƒã‚§ãƒƒã‚¯ã‚’ãƒˆãƒªã‚¬ãƒ¼ã—ã¾ã—ãŸ');
      } else {
        const d = await res.json();
        alert('ã‚¨ãƒ©ãƒ¼: ' + (d.detail || 'å¤±æ•—'));
      }
    } catch (e) {
      alert('ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼: ' + e);
    }
  }

  async function resetLearning() {
    if (!confirm('å­¦ç¿’ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ\ncontacts.md ã®è‡ªå‹•å­¦ç¿’æ¸ˆã¿ã‚»ã‚¯ã‚·ãƒ§ãƒ³ãŒæ¶ˆå»ã•ã‚Œã¾ã™ã€‚ã“ã®æ“ä½œã¯å…ƒã«æˆ»ã›ã¾ã›ã‚“ã€‚')) return;
    try {
      const res = await fetch('/api/reset-learning', { method: 'POST' });
      if (res.ok) {
        showToast('ğŸ“Š å­¦ç¿’ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸ');
        _settingsContactsLoaded = false;
      } else {
        const d = await res.json();
        alert('ã‚¨ãƒ©ãƒ¼: ' + (d.detail || 'å¤±æ•—'));
      }
    } catch (e) {
      alert('ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼: ' + e);
    }
  }

  // â”€â”€â”€ Toast â”€â”€â”€
  function showToast(msg) {
    const toast = document.getElementById('toast');
    toast.textContent = msg;
    toast.style.display = 'block';
    clearTimeout(toast._timer);
    toast._timer = setTimeout(() => { toast.style.display = 'none'; }, 3000);
  }

  // â”€â”€â”€ WebSocket â”€â”€â”€
  function connectWS() {
    const proto = location.protocol === 'https:' ? 'wss' : 'ws';
    const ws = new WebSocket(`${proto}://${location.host}/ws/live`);
    const dot = document.getElementById('ws-dot');
    const label = document.getElementById('ws-label');

    ws.onopen = () => {
      dot.classList.add('connected');
      label.textContent = 'æ¥ç¶šä¸­';
    };

    ws.onmessage = (e) => {
      try {
        const entry = JSON.parse(e.data);
        prependFeedItem(entry);
      } catch {}
    };

    ws.onclose = () => {
      dot.classList.remove('connected');
      label.textContent = 'åˆ‡æ–­ â€” å†æ¥ç¶šä¸­...';
      setTimeout(connectWS, 3000);
    };

    ws.onerror = () => ws.close();
  }

  function prependFeedItem(entry) {
    const feed = document.getElementById('live-feed');
    const empty = feed.querySelector('.empty-state');
    if (empty) feed.innerHTML = '';

    const div = document.createElement('div');
    div.className = 'feed-item';
    div.innerHTML = `
      <span class="feed-time">${esc(entry.timestamp || '')}</span>
      <span class="feed-msg">${esc(entry.message || '')}</span>
      <span class="feed-type ${esc(entry.type || 'info')}">${esc(entry.type || 'info')}</span>
    `;

    feed.insertBefore(div, feed.firstChild);
    while (feed.children.length > 50) feed.removeChild(feed.lastChild);
  }

  // â”€â”€â”€ ã‚¨ã‚¹ã‚±ãƒ¼ãƒ— â”€â”€â”€
  function esc(str) {
    return String(str || '')
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;')
      .replace(/"/g, '&quot;');
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // ã‚¿ã‚¹ã‚¯ç®¡ç† / Task management
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  // ã‚¿ã‚¹ã‚¯ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ»çŠ¶æ…‹å¤‰æ•° / Task cache and state variables
  let _tasksData    = [];    // å…¨ã‚¿ã‚¹ã‚¯ã‚­ãƒ£ãƒƒã‚·ãƒ¥ / Full task list cache
  let _tasksLoaded  = false; // åˆå›ãƒ­ãƒ¼ãƒ‰æ¸ˆã¿ãƒ•ãƒ©ã‚° / First load flag
  let _currentTaskId = null; // ç·¨é›†ä¸­ã‚¿ã‚¹ã‚¯ ID / Currently editing task ID

  // ã‚¿ã‚¹ã‚¯ä¸€è¦§ã‚’ API ã‹ã‚‰å–å¾—ã—ã¦ãƒœãƒ¼ãƒ‰ã‚’æç”»ã™ã‚‹
  // Fetch task list from API and render the board
  async function fetchTasks() {
    try {
      const res = await fetch('/api/tasks?limit=200');
      if (!res.ok) return;
      const tasks = await res.json();
      _tasksData   = tasks;
      _tasksLoaded = true;
      renderTaskBoard(tasks);
    } catch (e) {
      console.warn('fetchTasks error', e);
    }
  }

  // ã‚¿ã‚¹ã‚¯çµ±è¨ˆã‚’å–å¾—ã—ã¦ãƒŠãƒ“ãƒãƒƒã‚¸ã¨çµ±è¨ˆè¡Œã‚’æ›´æ–°ã™ã‚‹
  // Fetch task stats and update nav badge + stats row
  async function fetchTaskStats() {
    try {
      const res = await fetch('/api/tasks/stats');
      if (!res.ok) return;
      const s = await res.json();

      // ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ãƒãƒƒã‚¸ï¼ˆTodo + é€²è¡Œä¸­ã®åˆè¨ˆï¼‰/ Nav badge (todo + in_progress total)
      const active   = (s.todo || 0) + (s.in_progress || 0);
      const navBadge = document.getElementById('nav-tasks-count');
      if (navBadge) navBadge.textContent = active;

      // çµ±è¨ˆè¡Œã®å„ã‚»ãƒ« / Stats row cells
      _setEl('task-stat-total',      s.total       || 0);
      _setEl('task-stat-todo',       s.todo        || 0);
      _setEl('task-stat-inprogress', s.in_progress || 0);
      _setEl('task-stat-done',       s.done        || 0);
      _setEl('task-stat-overdue',    s.overdue     || 0);
    } catch (e) {
      console.warn('fetchTaskStats error', e);
    }
  }

  // æŒ‡å®š ID ã®è¦ç´ ãƒ†ã‚­ã‚¹ãƒˆã‚’æ›´æ–°ã™ã‚‹ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
  // Utility: set text content of element by id
  function _setEl(id, val) {
    const el = document.getElementById(id);
    if (el) el.textContent = val;
  }

  // ã‚¿ã‚¹ã‚¯ã‚’ 3 åˆ—ãƒœãƒ¼ãƒ‰ã«æç”»ã™ã‚‹ / Render tasks into the 3-column board
  function renderTaskBoard(tasks) {
    const colTodo   = document.getElementById('col-todo-body');
    const colInProg = document.getElementById('col-inprogress-body');
    const colDone   = document.getElementById('col-done-body');
    if (!colTodo || !colInProg || !colDone) return;

    // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã§ã‚°ãƒ«ãƒ¼ãƒ—åˆ†ã‘ / Group by status
    const todo       = tasks.filter(t => t.status === 'todo');
    const inProgress = tasks.filter(t => t.status === 'in_progress');
    const done       = tasks.filter(t => t.status === 'done');

    // åˆ—ãƒ˜ãƒƒãƒ€ãƒ¼ã®ã‚«ã‚¦ãƒ³ãƒˆãƒãƒƒã‚¸ã‚’æ›´æ–° / Update column header count badges
    _setEl('col-todo-count',       todo.length);
    _setEl('col-inprogress-count', inProgress.length);
    _setEl('col-done-count',       done.length);

    // ç©ºã®ã¨ãã®è¡¨ç¤º / Empty state HTML
    const emptyHTML = `<div class="empty-state" style="padding:24px 16px;">
      <div class="empty-icon">ğŸ“­</div>ã‚¿ã‚¹ã‚¯ãªã—</div>`;

    colTodo.innerHTML   = todo.length       ? todo.map(renderTaskCard).join('')       : emptyHTML;
    colInProg.innerHTML = inProgress.length ? inProgress.map(renderTaskCard).join('') : emptyHTML;
    colDone.innerHTML   = done.length       ? done.map(renderTaskCard).join('')       : emptyHTML;
  }

  // ä»Šæ—¥ã®æ—¥ä»˜ã‚’ "YYYY-MM-DD" å½¢å¼ã§è¿”ã™ / Return today's date as "YYYY-MM-DD"
  function _todayStr() {
    return new Date().toISOString().slice(0, 10);
  }

  // å„ªå…ˆåº¦ã®è¡¨ç¤ºãƒ©ãƒ™ãƒ«ã‚’è¿”ã™ / Return display label for priority
  function _priorityLabel(p) {
    return { urgent: 'P1 ç·Šæ€¥', high: 'P2 é«˜', medium: 'P3 ä¸­', low: 'P4 ä½' }[p] || p || '-';
  }

  // ã‚½ãƒ¼ã‚¹ã®ã‚¢ã‚¤ã‚³ãƒ³æ–‡å­—ã‚’è¿”ã™ / Return icon character for task source
  function _sourceIcon(s) {
    return { email: 'ğŸ“§', discord: 'ğŸ’¬', calendar: 'ğŸ“…', manual: 'âœï¸' }[s] || 'âœï¸';
  }

  // ã‚¿ã‚¹ã‚¯ã‚«ãƒ¼ãƒ‰ã® HTML æ–‡å­—åˆ—ã‚’ç”Ÿæˆã™ã‚‹ / Generate task card HTML string
  function renderTaskCard(task) {
    const priority  = task.priority || 'medium';
    const status    = task.status   || 'todo';
    const dueDate   = task.due_date  ? String(task.due_date).slice(0, 10) : '';
    const today     = _todayStr();
    const isOverdue = dueDate && dueDate < today && status !== 'done';

    // æœŸæ—¥è¡¨ç¤º HTML / Due date display HTML
    const dueDateHTML = dueDate
      ? `<div class="task-date ${isOverdue ? 'overdue' : ''}">${isOverdue ? 'âš ï¸ ' : 'ğŸ“… '}${esc(dueDate)}</div>`
      : '';

    // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹é·ç§»ãƒœã‚¿ãƒ³ï¼ˆã‚«ãƒ¼ãƒ‰ä¸Šã®ãƒ¯ãƒ³ã‚¯ãƒªãƒƒã‚¯æ“ä½œï¼‰
    // Status transition buttons (one-click action on the card)
    let actionBtns = '';
    if (status === 'todo') {
      // Todo â†’ In Progress
      actionBtns = `<button class="btn" style="font-size:11px;background:rgba(33,150,243,0.15);color:var(--info);border:1px solid rgba(33,150,243,0.3);"
          onclick="changeTaskStatus(${task.id},'in_progress');event.stopPropagation()">â–¶ é–‹å§‹</button>`;
    } else if (status === 'in_progress') {
      // In Progress â†’ Todo or Done
      actionBtns = `
        <button class="btn btn-secondary" style="font-size:11px;"
            onclick="changeTaskStatus(${task.id},'todo');event.stopPropagation()">â† æˆ»ã™</button>
        <button class="btn btn-approve" style="font-size:11px;"
            onclick="changeTaskStatus(${task.id},'done');event.stopPropagation()">âœ… å®Œäº†</button>`;
    } else if (status === 'done') {
      // Done â†’ In Progress
      actionBtns = `<button class="btn btn-secondary" style="font-size:11px;"
          onclick="changeTaskStatus(${task.id},'in_progress');event.stopPropagation()">â†© æˆ»ã™</button>`;
    }

    return `
      <div class="task-card" onclick="openTaskDetail(${task.id})">
        <div class="task-card-top">
          <span class="task-priority-badge ${esc(priority)}">${esc(_priorityLabel(priority))}</span>
          <span class="task-source-icon" title="${esc(task.source || 'manual')}">${_sourceIcon(task.source)}</span>
        </div>
        <div class="task-title">${esc(task.title)}</div>
        ${dueDateHTML}
        <div class="task-actions">${actionBtns}</div>
      </div>`;
  }

  // ã‚¿ã‚¹ã‚¯ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’å¤‰æ›´ã™ã‚‹ / Change task status via API
  async function changeTaskStatus(taskId, newStatus) {
    try {
      const res = await fetch('/api/tasks/' + taskId, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ status: newStatus }),
      });
      if (!res.ok) {
        const d = await res.json();
        showToast('âŒ ã‚¨ãƒ©ãƒ¼: ' + (d.detail || 'æ›´æ–°å¤±æ•—'));
        return;
      }
      showToast('âœ… ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’æ›´æ–°ã—ã¾ã—ãŸ');
      // ãƒœãƒ¼ãƒ‰ã¨ãƒãƒƒã‚¸ã‚’å†å–å¾— / Refresh board and badge
      fetchTasks();
      fetchTaskStats();
    } catch (e) {
      showToast('âŒ ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼: ' + e);
    }
  }

  // æ–°è¦ã‚¿ã‚¹ã‚¯ã‚’ä½œæˆã™ã‚‹ / Create a new task via API
  async function createTask() {
    const titleEl    = document.getElementById('new-task-title');
    const dueEl      = document.getElementById('new-task-due');
    const priorityEl = document.getElementById('new-task-priority');

    const title = titleEl?.value.trim();
    if (!title) {
      showToast('âš ï¸ ã‚¿ã‚¤ãƒˆãƒ«ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
      titleEl?.focus();
      return;
    }

    try {
      const res = await fetch('/api/tasks', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          title,
          due_date: dueEl?.value  || null,
          priority: priorityEl?.value || 'medium',
        }),
      });
      if (!res.ok) {
        const d = await res.json();
        showToast('âŒ ã‚¨ãƒ©ãƒ¼: ' + (d.detail || 'ä½œæˆå¤±æ•—'));
        return;
      }
      showToast('âœ… ã‚¿ã‚¹ã‚¯ã‚’è¿½åŠ ã—ã¾ã—ãŸ: ' + title);
      // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ãƒªã‚»ãƒƒãƒˆ / Reset form fields
      if (titleEl)    titleEl.value    = '';
      if (dueEl)      dueEl.value      = '';
      if (priorityEl) priorityEl.value = 'medium';
      fetchTasks();
      fetchTaskStats();
    } catch (e) {
      showToast('âŒ ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼: ' + e);
    }
  }

  // ã‚¿ã‚¹ã‚¯è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã„ã¦ãƒ•ã‚©ãƒ¼ãƒ ã«å€¤ã‚’åŸ‹ã‚ã‚‹
  // Open task detail modal and populate the edit form
  function openTaskDetail(taskId) {
    const task = _tasksData.find(t => t.id === taskId);
    if (!task) return;
    _currentTaskId = taskId;

    const titleEl    = document.getElementById('task-edit-title');
    const dueEl      = document.getElementById('task-edit-due');
    const priorityEl = document.getElementById('task-edit-priority');

    if (titleEl)    titleEl.value    = task.title    || '';
    if (dueEl)      dueEl.value      = (task.due_date || '').slice(0, 10);
    if (priorityEl) priorityEl.value = task.priority || 'medium';

    document.getElementById('task-modal').classList.add('open');
  }

  // ã‚¿ã‚¹ã‚¯è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹ / Close task detail modal
  function closeTaskModal() {
    document.getElementById('task-modal').classList.remove('open');
    _currentTaskId = null;
  }

  // ã‚¿ã‚¹ã‚¯ç·¨é›†å†…å®¹ã‚’ä¿å­˜ã™ã‚‹ / Save task edits via API
  async function saveTaskEdit() {
    if (_currentTaskId === null) return;

    const titleEl    = document.getElementById('task-edit-title');
    const dueEl      = document.getElementById('task-edit-due');
    const priorityEl = document.getElementById('task-edit-priority');

    const title = titleEl?.value.trim();
    if (!title) {
      showToast('âš ï¸ ã‚¿ã‚¤ãƒˆãƒ«ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
      titleEl?.focus();
      return;
    }

    try {
      const res = await fetch('/api/tasks/' + _currentTaskId, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          title,
          // ç©ºæ–‡å­—åˆ—ã‚’é€ã‚‹ã¨æœŸæ—¥ãŒ NULL ã‚¯ãƒªã‚¢ã•ã‚Œã‚‹ / Empty string clears due date to NULL
          due_date: dueEl?.value ?? '',
          priority: priorityEl?.value || 'medium',
        }),
      });
      if (!res.ok) {
        const d = await res.json();
        showToast('âŒ ã‚¨ãƒ©ãƒ¼: ' + (d.detail || 'ä¿å­˜å¤±æ•—'));
        return;
      }
      showToast('âœ… ã‚¿ã‚¹ã‚¯ã‚’ä¿å­˜ã—ã¾ã—ãŸ');
      closeTaskModal();
      fetchTasks();
      fetchTaskStats();
    } catch (e) {
      showToast('âŒ ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼: ' + e);
    }
  }

  // ã‚¿ã‚¹ã‚¯ã‚’å‰Šé™¤ã™ã‚‹ï¼ˆãƒ¢ãƒ¼ãƒ€ãƒ«ã‹ã‚‰ï¼‰/ Delete task (from detail modal)
  async function deleteTaskFromModal() {
    if (_currentTaskId === null) return;

    const task  = _tasksData.find(t => t.id === _currentTaskId);
    const title = task?.title || 'ã“ã®ã‚¿ã‚¹ã‚¯';

    // å‰Šé™¤ç¢ºèª / Confirm deletion
    if (!confirm(`ã€Œ${title}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\nã“ã®æ“ä½œã¯å…ƒã«æˆ»ã›ã¾ã›ã‚“ã€‚`)) return;

    try {
      const res = await fetch('/api/tasks/' + _currentTaskId, { method: 'DELETE' });
      if (!res.ok) {
        const d = await res.json();
        showToast('âŒ ã‚¨ãƒ©ãƒ¼: ' + (d.detail || 'å‰Šé™¤å¤±æ•—'));
        return;
      }
      showToast('ğŸ—‘ï¸ ã‚¿ã‚¹ã‚¯ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
      closeTaskModal();
      fetchTasks();
      fetchTaskStats();
    } catch (e) {
      showToast('âŒ ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼: ' + e);
    }
  }

  // ã‚¿ã‚¹ã‚¯ãƒ¢ãƒ¼ãƒ€ãƒ«ã®ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
  // Close task modal when clicking the overlay background
  document.getElementById('task-modal').addEventListener('click', function(e) {
    if (e.target === this) closeTaskModal();
  });

  // â”€â”€â”€ åˆæœŸåŒ– â”€â”€â”€
  fetchStatus();
  fetchApiUsage();
  // ã‚¿ã‚¹ã‚¯çµ±è¨ˆã¯èµ·å‹•æ™‚ã¨ãã®å¾Œ30ç§’æ¯ã«å–å¾— / Fetch task stats on startup, then every 30s
  fetchTaskStats();
  setInterval(fetchStatus, 5000);
  setInterval(fetchApiUsage, 30000);
  setInterval(fetchTaskStats, 30000);
  connectWS();

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // Expense management
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  // Initialize month picker to current month on first render
  (function initExpenseMonth() {
    const picker = document.getElementById('exp-month-picker');
    if (picker) {
      const now = new Date();
      picker.value = now.toISOString().slice(0, 7);
    }
    // Set annual CSV link to current year
    const year = new Date().getFullYear();
    const link = document.getElementById('exp-csv-link');
    if (link) link.href = `/api/expenses/annual/${year}/csv`;
  })();

  // Fetch and render the expense view for the selected month
  async function fetchExpenses() {
    const picker = document.getElementById('exp-month-picker');
    const month  = picker ? picker.value : new Date().toISOString().slice(0, 7);

    if (!month) return;

    const [yearStr, monthStr] = month.split('-');
    const year  = parseInt(yearStr,  10);
    const monthN = parseInt(monthStr, 10);

    // Update CSV link year
    const link = document.getElementById('exp-csv-link');
    if (link) link.href = `/api/expenses/annual/${year}/csv`;

    // Fetch monthly summary for bar chart and stats
    try {
      const res = await fetch(`/api/expenses/monthly/${year}/${monthN}`);
      if (res.ok) {
        const rows = await res.json();
        renderExpenseChart(rows);
        renderExpenseStats(rows);
      }
    } catch (e) {
      console.warn('fetchExpenses monthly error', e);
    }

    // Fetch expense list for the table
    try {
      const res = await fetch(`/api/expenses?month=${encodeURIComponent(month)}&limit=100`);
      if (res.ok) {
        const expenses = await res.json();
        renderExpenseTable(expenses);
      }
    } catch (e) {
      console.warn('fetchExpenses list error', e);
    }
  }

  // Render per-category stats (total, count, match rate) into stat items
  function renderExpenseStats(rows) {
    const grandTotal = rows.reduce((s, r) => s + (r.total_amount || 0), 0);
    const grandCount = rows.reduce((s, r) => s + (r.count || 0), 0);
    _setEl('exp-stat-total', 'Â¥' + grandTotal.toLocaleString('ja-JP'));
    _setEl('exp-stat-count', grandCount);
    // Match rate is shown separately via the expense list; leave the stat as-is
  }

  // Render CSS-only horizontal bar chart for category breakdown
  function renderExpenseChart(rows) {
    const el = document.getElementById('exp-chart-body');
    if (!el) return;
    if (!rows || !rows.length) {
      el.innerHTML = `<div class="empty-state"><div class="empty-icon">ğŸ“Š</div>ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</div>`;
      return;
    }
    const maxAmt = Math.max(...rows.map(r => r.total_amount || 0), 1);
    el.innerHTML = rows.map(r => {
      const cat = r.category || 'æœªåˆ†é¡';
      const amt = r.total_amount || 0;
      const pct = Math.round(amt / maxAmt * 100);
      return `
        <div class="exp-bar-row">
          <span class="exp-bar-label" title="${esc(cat)}">${esc(cat)}</span>
          <div class="exp-bar-wrap">
            <div class="exp-bar-fill" style="width:${pct}%"></div>
          </div>
          <span class="exp-bar-amount">Â¥${amt.toLocaleString('ja-JP')}</span>
        </div>`;
    }).join('');
  }

  // Render the expense list table
  function renderExpenseTable(expenses) {
    const tbody = document.getElementById('exp-tbody');
    if (!tbody) return;
    if (!expenses || !expenses.length) {
      tbody.innerHTML = `<tr><td colspan="6">
        <div class="empty-state"><div class="empty-icon">ğŸ’³</div>çµŒè²»ãŒã‚ã‚Šã¾ã›ã‚“</div>
      </td></tr>`;
      return;
    }

    // Compute match rate for stat badge
    const matched = expenses.filter(e => e.moneyforward_matched).length;
    const rate = expenses.length ? Math.round(matched / expenses.length * 100) : 0;
    _setEl('exp-stat-match', rate + '%');

    const pmLabel = { cash: 'ç¾é‡‘', credit_card: 'ã‚«ãƒ¼ãƒ‰', electronic: 'é›»å­ãƒãƒãƒ¼' };

    tbody.innerHTML = expenses.map(e => {
      const dateStr = (e.date || '').slice(0, 10);
      const store   = e.store_name || '';
      const amount  = e.amount || 0;
      const cat     = e.category || '-';
      const pm      = e.payment_method || 'cash';
      const mf      = e.moneyforward_matched ? 1 : 0;
      return `
        <tr>
          <td style="font-size:11px;color:var(--text-dim);white-space:nowrap;">${esc(dateStr)}</td>
          <td style="max-width:140px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;"
              title="${esc(store)}">${esc(store)}</td>
          <td style="text-align:right;font-variant-numeric:tabular-nums;">Â¥${amount.toLocaleString('ja-JP')}</td>
          <td><span class="category-tag info-tag">${esc(cat)}</span></td>
          <td><span class="pm-tag">${esc(pmLabel[pm] || pm)}</span></td>
          <td><span class="match-tag ${mf ? 'matched' : 'unmatched'}">${mf ? 'ç…§åˆæ¸ˆ' : 'æœªç…§åˆ'}</span></td>
        </tr>`;
    }).join('');
  }

  // Upload a MoneyForward CSV file via the import endpoint
  async function uploadMfCsv(input) {
    const statusEl = document.getElementById('exp-upload-status');
    if (!input.files || !input.files[0]) return;
    const file = input.files[0];
    if (statusEl) statusEl.textContent = `ğŸ“¤ ${file.name} ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­...`;

    const form = new FormData();
    form.append('file', file);

    try {
      const res = await fetch('/api/expenses/import-mf', {
        method: 'POST',
        body: form,
      });
      const data = await res.json();
      if (!res.ok) {
        if (statusEl) statusEl.textContent = `âŒ ã‚¨ãƒ©ãƒ¼: ${data.detail || 'å¤±æ•—'}`;
        return;
      }
      const msg = `âœ… ${data.imported}ä»¶ ã‚¤ãƒ³ãƒãƒ¼ãƒˆï¼ˆã‚¹ã‚­ãƒƒãƒ—: ${data.skipped}ä»¶ï¼‰`;
      if (statusEl) statusEl.textContent = msg;
      showToast(msg);
      fetchExpenses();
    } catch (e) {
      if (statusEl) statusEl.textContent = `âŒ ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼: ${e}`;
    } finally {
      // Reset the file input so the same file can be re-uploaded if needed
      input.value = '';
    }
  }

  // Create a new manual expense entry
  async function createExpense() {
    const date  = document.getElementById('exp-new-date')?.value;
    const store = document.getElementById('exp-new-store')?.value.trim();
    const amt   = parseInt(document.getElementById('exp-new-amount')?.value || '0', 10);
    const cat   = document.getElementById('exp-new-category')?.value || '';
    const pm    = document.getElementById('exp-new-pm')?.value || 'cash';
    const note  = document.getElementById('exp-new-note')?.value.trim() || null;

    if (!date)  { showToast('âš ï¸ æ—¥ä»˜ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
    if (!store) { showToast('âš ï¸ åº—èˆ—åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
    if (!amt || amt <= 0) { showToast('âš ï¸ é‡‘é¡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }

    try {
      const res = await fetch('/api/expenses', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ date, store_name: store, amount: amt, category: cat, payment_method: pm, note }),
      });
      const data = await res.json();
      if (!res.ok) {
        showToast('âŒ ã‚¨ãƒ©ãƒ¼: ' + (data.detail || 'ä½œæˆå¤±æ•—'));
        return;
      }
      showToast(`âœ… çµŒè²»ã‚’è¿½åŠ ã—ã¾ã—ãŸ: ${store} Â¥${amt.toLocaleString('ja-JP')}`);
      // Reset form
      ['exp-new-date','exp-new-store','exp-new-amount','exp-new-note'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.value = '';
      });
      fetchExpenses();
    } catch (e) {
      showToast('âŒ ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼: ' + e);
    }
  }

  // Wire showView to load expense data on first visit
  const _origShowView = showView;
  showView = function(id, navEl) {
    _origShowView(id, navEl);
    if (id === 'expenses') {
      fetchExpenses();
    }
  };
</script>
</body>
</html>
